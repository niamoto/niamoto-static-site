<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Niamoto - 18.0</title>
    <link rel="stylesheet" href="../js/vendor/tailwindcss/2.2.19_dist_tailwind.css">
    <link rel="stylesheet" href="../js/vendor/leaflet/1.9.4_leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
<script src="../js/shape_list.js"></script>

<style>
    #shape-type-list li, #shape-list li {
        list-style: none;
        text-transform: capitalize;
    }

    .shape-type-link, .shape-link {
        display: block;
        padding: 10px;
        border-radius: 5px;
        text-decoration: none;
    }

    .shape-type-link:hover, .shape-link:hover {
        background-color: #f0f0f0;
    }

    .shape-type-link.active, .shape-link.active {
        background-color: #3498db;
        color: #fff;
    }

    #shapeMap, #allShapesMap {
        position: relative;
        height: 300px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #allShapesMap {
        height: 400px;
    }

    .chart-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .chart-container > div {
        flex: 1 1 calc(33.333% - 10px);
        margin: 5px;
    }
    .custom-tooltip {
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    font-size: 12px;
    max-width: 300px;
    word-wrap: break-word;
}
</style>

    <style>
        .gauge {
            height: 349px;
        }

        ul {
            list-style-type: none;
        }

        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bg p-4 fixed w-full top-0 shadow-md z-50 custom-nav">
    <div class="container mx-auto flex flex-wrap items-center justify-between">
        <div class="flex items-center flex-shrink-0 text-white mr-6">
            <a id="home-link" class="inline-flex items-center py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                <span class="site-title">Niamoto</span>
            </a>
        </div>

        <div class="block lg:hidden">
            <button id="nav-toggle"
                class="flex items-center px-3 py-2 border rounded text-teal-200 border-teal-400 hover:text-white hover:border-white">
                <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <title>Menu</title>
                    <path d="M0 3h20v2H0zm0 6h20v2H0zm0 6h20v2H0z" />
                </svg>
            </button>
        </div>
        <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block pt-6 lg:pt-0" id="nav-content">
            <ul class="list-reset lg:flex justify-end flex-1 items-center">
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                        <i class="fas fa-home menu-icon"></i>Accueil
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#introduction">Introduction</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#project">Projet</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#objective">Objectifs</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#context">Contexte</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#flora">Flore</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="methodology.html">
                        <i class="fas fa-flask menu-icon"></i>Méthodologie
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#methodes">Nos méthodes</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#faq">FAQ</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="trees.html">
                        <i class="fas fa-leaf menu-icon"></i>Arbres
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#learnTaxon">Étudier les
                arbres</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#taxon">Les arbres de
                Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="plots.html">
                        <i class="fas fa-map-marked-alt menu-icon"></i>Peuplements
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#learnPlot">Étudier les
                            peuplements forestiers</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#plot">Les
                peuplements forestiers de Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="forests.html">
                        <i class="fas fa-tree menu-icon"></i>Forêt
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#learnForest">Étudier les
                forêts</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPN">La forêt de la
                province Nord</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPS">La forêt de la
                province Sud</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="resources.html">
                        <i class="fas fa-book menu-icon"></i>Ressources
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#equipe">L'équipe</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#article">Articles</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#academic">Académique</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#media-production">Médias</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
  document.getElementById('nav-toggle').onclick = function () {
    document.getElementById('nav-content').classList.toggle('hidden');
  };

  // Function to adjust the navigation links based on page depth
  function adjustNavLinks(depth) {
    document.querySelectorAll('a[data-link]').forEach(link => {
      link.href = depth + link.getAttribute('data-link');
    });
  }

  // Adjust the navigation links based on the depth
  adjustNavLinks("../");
</script>

<style>
    .site-title {
        font-family: 'Arial Black', sans-serif; /* Custom font for a bold effect */
        font-size: 2rem; /* Increased font size */
        text-transform: uppercase; /* Uppercase letters for visibility */
        letter-spacing: 2px; /* Spacing between letters */
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7); /* Text shadow for better visibility */
        transition: color 0.3s; /* Smooth transition for hover effect */
    }

    .site-title:hover {
        color: #ffdd57; /* Change color on hover */
    }

    .text-contour {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .nav-bg {
        background-color: rgba(34, 139, 34, 0.8); /* Fond vert semi-transparent */
        transition: background-color 0.3s;
    }

    .nav-bg:hover {
        background-color: rgba(34, 139, 34, 1); /* Fond vert opaque au survol */
    }

    .group:hover .group-hover\:block {
        display: block;
    }

    .custom-nav {
        z-index: 500;
    }

    .custom-dropdown {
        z-index: 500;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2); /* Fond blanc transparent au survol */
        border-radius: 4px;
    }

    .menu-icon {
        margin-right: 8px;
    }
</style>
    <div class="flex">
        
<aside class="w-1/4 p-4 mt-28">
    <h2 class="font-semibold text-lg mb-4">Shape Types</h2>
    <ul id="shape-type-list" class="list-disc pl-5">
        <!-- The list of shape types will be generated by JavaScript -->
    </ul>
</aside>

        <div class="w-full">
            
<div id="allShapesMap" class="mt-28"></div>

<div class="rounded overflow-hidden shadow-lg mb-2 mt-8">
    <div class="px-6 py-4">
        <div class="font-bold text-4xl mb-2">18.0</div>
    </div>
</div>

<div class="chart-container">
    <!-- Section for general information -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">General Information</h2>
            
                
                    
                        
                        
                            <p>Shape Area (Total Area): 2758.884927759538</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Forest Area (Forest Area): 2531.592670109511</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Number of Families (Number of Families): 66</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Species (Number of Species): 245</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Occurrences (Number of Occurrences): 1761</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Average Rainfall (Average Rainfall): 3699.199951171875</p>
                        
                    
                
                    
                        
                        
                            <p>Average Rainfall (Rainfall Range): {"min": 3170.0, "max": 4710.0}</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Altitude (Median Altitude): 668.0</p>
                        
                    
                
                    
                        
                        
                            <p>Altitude (Maximum Altitude): 1470.0</p>
                        
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        </div>
    </div>

    <!-- Section for shape map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Shape Map</h2>
            <div id="shapeMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="shapeMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Section for forest map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Forest Map</h2>
            <div id="forestMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="forestMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div class="flex flex-wrap -mx-2">
    

    

    
    
        
    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
    
        
            
            

            
            
                
            
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Elevation Distribution</h2>
        
    
    
        <canvas id="elevationDistributionChart"></canvas>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Forest Fragment Distribution</h2>
        
    
    
        <canvas id="forestFragmentationChart"></canvas>
    
    
                        </div>
                    </div>
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Fragmentation</h2>
        
    
    
        <div class="gauge" id="forest_fragmentationeffective_mesh_sizeGauge"></div>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
</div>

        </div>
    </div>
    <footer class="bg-green-700 text-white p-4 mt-8">
        <div class="container mx-auto">
            <div class="flex justify-center mb-4">
                <div class="bg-white p-2 rounded-lg shadow-md flex justify-center">
                    <figure class="mx-2"><img class="img-fluid" src="../files/ps_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/pn_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/amap_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/herbarium_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/iac_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/ird_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/cirad_100.png"></figure>
                </div>
            </div>
            <div class="text-center">
                <p>Niamoto - Portail de la forêt de Nouvelle-Calédonie</p>
                <a class="inline-block py-2 px-4 text-white no-underline" href="https://github.com/niamoto/niamoto" target="_blank">
                    <span class="fab fa-github fa-lg" aria-hidden="true"></span> Github
                </a>
            </div>
        </div>
    </footer>
    <script src="../js/vendor/chart/4.4.2_chart.js"></script>
    <script src="../js/vendor/d3/7.8.5_d3.js"></script>
    <script src="../js/vendor/jquery/3.6.0_jquery.js"></script>
    <script src="../js/vendor/raphael/2.3.0_raphael.js"></script>
    <script src="../js/vendor/justgage/1.6.1_justgage.js"></script>
    <script src="../js/vendor/leaflet/1.9.4_leaflet.js"></script>
    
<script>
    var shape = {"elevation_elevation_distribution": {"altitudes": [46.0, 146.0, 246.0, 346.0, 446.0, 546.0, 646.0, 746.0, 846.0, 946.0, 1046.0, 1146.0, 1246.0, 1346.0, 1446.0], "forest": [85.56863672628893, 134.4650005698826, 168.91471145968723, 180.02752142414033, 256.70591017886676, 358.94376185183535, 323.38276996558545, 288.9330590757808, 321.1602079726948, 205.5869843423825, 58.89789281160147, 52.2302068329296, 94.45888469785142, 16.669214946679663, 0.0], "non_forest": [12.224090960898419, 11.112809964453108, 33.338429893359326, 23.336900925351525, 25.559462918242147, 22.225619928906216, 6.667685978671864, 10.001528968007797, 15.55793395023435, 21.114338932460903, 11.112809964453108, 4.445123985781243, 12.224090960898419, 10.001528968007797, 1.1112809964453108]}, "elevation_max": 1470.0, "elevation_median": 668.0, "forest_area": "2531.592670109511", "forest_coordinates": "{\"type\": \"MultiPolygon\", \"coordinates\": [[[[166.55378910182435, -21.998302839159006], [166.55378910182435, -21.998528060560584], [166.55350718294758, -21.997969838074273], [166.55371322216845, -21.99813210993325], [166.55378910182435, -21.998302839159006]]], [[[166.56970379601682, -21.91414826117378], [166.57270393166445, -21.91371534590914], [166.57291497426806, -21.915436521475133], [166.57376290575536, -21.914984894221014], [166.5765724395279, -21.916942981046912], [166.5762306239469, -21.919351505574202], [166.57804855757604, -21.92134429434077], [166.5824721512475, -21.91890042460366], [166.5817190950766, -21.91789832229649], [166.5856593759871, -21.918593964483655], [166.58601199951002, -21.923629255826683], [166.58825817882433, -21.923420749729996], [166.5889397339182, -21.9254622895459], [166.58832083519596, -21.92803073279226], [166.58689195380603, -21.927589351477668], [166.58124188174446, -21.93383116032901], [166.57961340056372, -21.933501599267267], [166.57935930834466, -21.935691996961246], [166.57608872143174, -21.936352368516832], [166.57492016381136, -21.93979578446147], [166.57372449909883, -21.93790537731069], [166.57217974074774, -21.93985764860099], [166.57161191304388, -21.937063349203083], [166.56918509896812, -21.939878832720673], [166.56818042771616, -21.938000147761674], [166.56735462945673, -21.940815607120452], [166.56600938523613, -21.93983143400826], [166.56600938523613, -21.944808298812085], [166.56770930620132, -21.944957588582064], [166.56628023873742, -21.946298302103227], [166.5600869423889, -21.946178191603195], [166.56233605527154, -21.953718701602913], [166.55973956123557, -21.95808630922744], [166.56819618675, -21.964411830479847], [166.56602852006299, -21.965736422947163], [166.56762176321584, -21.96529677210621], [166.56939447805703, -21.966599245982255], [166.57000449229315, -21.96592688169643], [166.57179943031053, -21.970209301828007], [166.5774590044859, -21.97089450446772], [166.58018674672277, -21.975648321712345], [166.57918614222157, -21.98243916055798], [166.57658507744304, -21.983805058086954], [166.57457693641877, -21.981702193429438], [166.57352729731323, -21.983686520442852], [166.57697854526245, -21.986981097112857], [166.5775950859067, -21.99064510783211], [166.5826156290732, -21.992987914963635], [166.58323830353967, -21.997758287157396], [166.58081448766634, -21.99733159291097], [166.58326255044022, -21.999372183796915], [166.584161206005, -22.00358937119408], [166.5821165083564, -22.000291831197185], [166.5803767095995, -22.00023773367497], [166.57979819920484, -22.001167143817206], [166.5802249691681, -22.002362099714368], [166.5814602753906, -22.000658557612624], [166.58417191986524, -22.006226494408274], [166.5801278960217, -22.009832538313542], [166.57706602584128, -22.007556401718244], [166.57665355134193, -22.01052894193003], [166.5746250958715, -22.010980160702093], [166.57245835213277, -22.010918647570836], [166.57340166411842, -22.010365682997843], [166.5715611167866, -22.006475866472016], [166.57046058333052, -22.006893310196737], [166.57085244760444, -22.01036896683053], [166.5679572916314, -22.00846738607257], [166.56713988344245, -22.00541074455204], [166.5608147001615, -22.004199665460455], [166.560996944344, -22.001248332555573], [166.55884573130012, -22.00245813277541], [166.5550007643132, -21.99980668679925], [166.5541208566616, -21.998954121317304], [166.55551536399588, -21.996927520395968], [166.55220157536021, -21.994938892494844], [166.55268395690388, -21.990676367402006], [166.55516442058743, -21.98944388933364], [166.55561969852278, -21.987158014699897], [166.55794351298445, -21.98734771383963], [166.55611014309778, -21.984667862637078], [166.55929511935503, -21.983496821303117], [166.55864065732297, -21.98208356271213], [166.55934515686002, -21.98150958028949], [166.56291229496256, -21.981459448269696], [166.56498701821542, -21.98347886604678], [166.56620491051964, -21.981789529045557], [166.5685382099383, -21.982870814142014], [166.56776163491662, -21.981420536490056], [166.56935391623915, -21.98118249179842], [166.56851906166114, -21.98071193720774], [166.56681403197078, -21.976348425883565], [166.5582344457619, -21.976830295830524], [166.55586049549996, -21.97435829648588], [166.55608920389366, -21.972257147274142], [166.54977568079843, -21.969965195437435], [166.54754914686927, -21.96760446576005], [166.54423413461464, -21.971240233904787], [166.53867571288947, -21.97095363828474], [166.5339596445379, -21.965120681663695], [166.5333086276747, -21.966253705166203], [166.53181669857065, -21.96563316235063], [166.5330107706179, -21.964238228918067], [166.52929423407255, -21.963346054803147], [166.52788149311894, -21.96038136341365], [166.53024717532574, -21.959797498972332], [166.52811680135116, -21.958196687859612], [166.53046067195768, -21.958433492712246], [166.52941031591953, -21.956131918758352], [166.53048074630664, -21.955430841859638], [166.53229029015236, -21.956762388886055], [166.53298459403905, -21.954878996696284], [166.5384954540045, -21.956941120486015], [166.536322788972, -21.958728457690402], [166.5391892817718, -21.957252703603196], [166.54204663445515, -21.95824271192529], [166.54419708237307, -21.960450513804904], [166.54457672804853, -21.962438355888512], [166.54686164234388, -21.96407856407564], [166.54830275011525, -21.96383205879896], [166.5465278676827, -21.961207443368835], [166.55050233566098, -21.961736763947197], [166.5458567257858, -21.960373338178563], [166.5452149910708, -21.951736525704025], [166.5471735841517, -21.947563978451218], [166.55468733757854, -21.943240291455883], [166.5543832979142, -21.942040306214942], [166.54950231034786, -21.943654978518744], [166.54487373286412, -21.943187052172558], [166.54249474569653, -21.94053749644084], [166.54243835924228, -21.935308324103907], [166.54563246623826, -21.932267615120786], [166.55626141432646, -21.929371556719676], [166.5594953455954, -21.926941365441667], [166.56456143612328, -21.926694791278607], [166.56180359369299, -21.923903316330758], [166.56176543728273, -21.920405772358176], [166.5633025956007, -21.918211124896402], [166.5663146932407, -21.917157506497734], [166.56672106858946, -21.91607717650794], [166.5679040238071, -21.914703785114515], [166.56970379601682, -21.91414826117378]], [[166.567788536831, -21.966170204857654], [166.56721964252213, -21.965904720846854], [166.56775061054375, -21.96688132274372], [166.56796868669548, -21.966710654451063], [166.567788536831, -21.966170204857654]], [[166.57636721308654, -21.97543859318268], [166.5767366352561, -21.975258618279558], [166.5771723639689, -21.974140879407546], [166.57577992656056, -21.975599623359155], [166.57636721308654, -21.97543859318268]], [[166.54702755935708, -21.96522576170941], [166.54664832046987, -21.96489392768311], [166.5470560022736, -21.965785139068025], [166.5478524039367, -21.966221263788302], [166.54702755935708, -21.96522576170941]], [[166.54291281743096, -21.959556140345814], [166.54274215993172, -21.95968887395633], [166.54351011867828, -21.96019136548187], [166.5434153089565, -21.959802645622492], [166.54291281743096, -21.959556140345814]], [[166.54186176841398, -21.95999309789066], [166.54167206927426, -21.961140777686023], [166.5422601366074, -21.961406356481643], [166.54194713302687, -21.95969906422408], [166.5407899682745, -21.960827774105468], [166.54186176841398, -21.95999309789066]], [[166.5429857358169, -21.96872874327518], [166.54253045788155, -21.969013291984773], [166.54272964197827, -21.96950650974807], [166.54316594999963, -21.969440115049164], [166.5429857358169, -21.96872874327518]], [[166.55935677157547, -21.98452119665766], [166.55957492558613, -21.983857249668606], [166.55876870424228, -21.98396158419546], [166.55878767415626, -21.984284072732997], [166.55935677157547, -21.98452119665766]], [[166.55970297250545, -21.98221635210994], [166.55920975474214, -21.982491415862548], [166.55957018310764, -21.983126907980644], [166.55995906634408, -21.982775964572145], [166.55970297250545, -21.98221635210994]], [[166.5681303567879, -21.97690477619752], [166.56754228945474, -21.976980655853414], [166.5674284699709, -21.97753078335863], [166.56793117269117, -21.97760666301452], [166.5681303567879, -21.97690477619752]], [[166.55561969852278, -21.99140727542984], [166.55519287545837, -21.99111324176326], [166.55546793921098, -21.992042767547932], [166.5556671233077, -21.991957402935054], [166.55561969852278, -21.99140727542984]], [[166.53061723615446, -21.95684650108104], [166.53098729698328, -21.956125356901815], [166.53095883076568, -21.95590711590021], [166.52985813701844, -21.956447974034628], [166.53061723615446, -21.95684650108104]], [[166.584495710391, -21.923995877543955], [166.58394596840273, -21.923521962036837], [166.58374692388975, -21.92442240150036], [166.58410709967515, -21.924460314740934], [166.584495710391, -21.923995877543955]], [[166.58221178365417, -21.930844125778215], [166.58192786816423, -21.930581557667505], [166.58147303634317, -21.930566398900012], [166.58176181399426, -21.93126826861727], [166.58221178365417, -21.930844125778215]], [[166.58098795578343, -21.930566398900012], [166.58012390603645, -21.930323858620152], [166.57992684205905, -21.930854415482344], [166.5803512875488, -21.93114243206468], [166.58098795578343, -21.930566398900012]], [[166.5792035873559, -21.931273501834937], [166.57926992823099, -21.931861092442794], [166.57976274616016, -21.93182318337132], [166.5797817006959, -21.931538865335263], [166.5792035873559, -21.931273501834937]], [[166.57506523227107, -21.917823592033542], [166.5747242221913, -21.917236296896156], [166.5739410093488, -21.917978976008868], [166.5747242221913, -21.918155129611097], [166.57506523227107, -21.917823592033542]], [[166.57362205740344, -21.91727087784268], [166.5744511901385, -21.91638987672695], [166.57411022526173, -21.915679533233675], [166.57240540087787, -21.917119162713377], [166.57362205740344, -21.91727087784268]], [[166.569043108343, -21.915925785644678], [166.5682020461292, -21.915084596188215], [166.5674724607411, -21.91533094969588], [166.56763353803458, -21.91566257941773], [166.569043108343, -21.915925785644678]], [[166.57622367757972, -21.917922146094405], [166.57570273669714, -21.917363318602185], [166.57524809738143, -21.91802633427092], [166.57539964382002, -21.918234710623953], [166.57622367757972, -21.917922146094405]], [[166.57519470304746, -21.927236185722897], [166.57237252042455, -21.928294940729565], [166.573004175122, -21.926385023975644], [166.56898235395957, -21.928724116778273], [166.5672764457432, -21.92789011720583], [166.56862221778056, -21.92993720706546], [166.57208142055262, -21.929415957332683], [166.57359304477765, -21.93169997888903], [166.57365938565275, -21.93000354794054], [166.57535581660122, -21.93232547856836], [166.5786066658364, -21.929062804981506], [166.5738577406727, -21.92890172034379], [166.57519470304746, -21.927236185722897]], [[166.56463989261695, -21.96859595387737], [166.5624298976391, -21.970085092124243], [166.56718527182431, -21.967177621862923], [166.56639830136376, -21.96699747199845], [166.56463989261695, -21.96859595387737]], [[166.57188165727607, -21.983117423023664], [166.57302933707143, -21.984084888636286], [166.57393040798516, -21.98059442446526], [166.5691574387617, -21.98169390831045], [166.57188165727607, -21.983117423023664]], [[166.5446999806869, -21.962893442553145], [166.54292703888922, -21.962751227970447], [166.54437762763277, -21.96474223212823], [166.54504129568534, -21.9636708822719], [166.5446999806869, -21.962893442553145]], [[166.5356586065448, -21.956237054924014], [166.53432122760972, -21.95678718242923], [166.53515590382455, -21.95769773829993], [166.53617111107195, -21.9570979202652], [166.5356586065448, -21.956237054924014]], [[166.53892143174818, -21.96098901837424], [166.54005014162956, -21.96149172109452], [166.5402227147584, -21.95969460972043], [166.5395480067097, -21.95980706106187], [166.53892143174818, -21.96098901837424]]], [[[166.57643947190363, -21.938845540789984], [166.57666698572322, -21.9386654256828], [166.57696679319642, -21.93869683263834], [166.57654687395566, -21.939027060707044], [166.57643947190363, -21.938845540789984]]], [[[166.58216167345446, -21.9331313251339], [166.58529759242518, -21.931488582155453], [166.58694834436537, -21.928488785359775], [166.5877752019395, -21.92845085611325], [166.58559245948396, -21.932274941598607], [166.58216167345446, -21.9331313251339]]]]}", "forest_cover_percentage": null, "forest_fragmentation_effective_mesh_size": 25.313548956804848, "forest_fragmentation_fragment_size_distribution": {"10": 0.004696363658930941, "100": 0.004696363658930941, "1000": 0.004696363658930941, "1100": 0.004696363658930941, "1200": 0.004696363658930941, "12000": 100.0, "125": 0.004696363658930941, "1300": 0.004696363658930941, "1400": 0.004696363658930941, "150": 0.004696363658930941, "1500": 0.004696363658930941, "1600": 0.004696363658930941, "1700": 0.004696363658930941, "17000": 100.0, "175": 0.004696363658930941, "1800": 0.004696363658930941, "1900": 0.004696363658930941, "20": 0.004696363658930941, "200": 0.004696363658930941, "2000": 0.004696363658930941, "225": 0.004696363658930941, "250": 0.004696363658930941, "27000": 100.0, "275": 0.004696363658930941, "30": 0.004696363658930941, "300": 0.004696363658930941, "325": 0.004696363658930941, "350": 0.004696363658930941, "375": 0.004696363658930941, "40": 0.004696363658930941, "400": 0.004696363658930941, "425": 0.004696363658930941, "450": 0.004696363658930941, "475": 0.004696363658930941, "50": 0.004696363658930941, "500": 0.004696363658930941, "500000": 100.0, "60": 0.004696363658930941, "600": 0.004696363658930941, "70": 0.004696363658930941, "700": 0.004696363658930941, "7000": 100.0, "80": 0.004696363658930941, "800": 0.004696363658930941, "90": 0.004696363658930941, "900": 0.004696363658930941}, "forest_humidity_category_distribution": null, "frequencies": {}, "id": 139, "land_use_category_distribution": null, "name": "18.0", "num_families_unique_taxonomic_count": 66, "num_occurrences_count": 1761, "num_species_unique_taxonomic_count": 245, "rainfall_mean": "3699.199951171875", "rainfall_range": "{\"min\": 3170.0, \"max\": 4710.0}", "shape_area": "2758.884927759538", "shape_coordinates": "{\"type\": \"FeatureCollection\", \"features\": [{\"id\": \"0\", \"type\": \"Feature\", \"properties\": {}, \"geometry\": {\"type\": \"Polygon\", \"coordinates\": [[[166.52792176883798, -21.959506660138963], [166.52941031591953, -21.956131918758352], [166.53395353740186, -21.95501308282641], [166.54204663445515, -21.95824271192529], [166.54624082378112, -21.963309693397296], [166.54539072983354, -21.95086656935652], [166.54783777448006, -21.9469317105201], [166.55468733757854, -21.943240291455883], [166.5543832979142, -21.942040306214942], [166.5494590598301, -21.943659364861222], [166.54407947243863, -21.942702663320755], [166.54230027296725, -21.939671016797053], [166.54279263413284, -21.93448707311169], [166.5594953455954, -21.926941365441667], [166.56456143612328, -21.926694791278607], [166.56180359369299, -21.923903316330758], [166.56176543728273, -21.920405772358176], [166.5679040238071, -21.914703785114515], [166.57330833602674, -21.91382153385084], [166.57879653057566, -21.918765788711262], [166.58296399092416, -21.917859847726294], [166.58639871243565, -21.919147759775775], [166.58892459789297, -21.926198282703854], [166.58559245948396, -21.932274941598607], [166.57961340056372, -21.933501599267267], [166.57686599421993, -21.93880041483478], [166.5694355176718, -21.94106254124885], [166.56628023873742, -21.946298302103227], [166.5600869423889, -21.946178191603195], [166.56233605527154, -21.953718701602913], [166.55973956123557, -21.95808630922744], [166.56971647016653, -21.965533589525798], [166.57179943031053, -21.970209301828007], [166.57666448381397, -21.97041029041844], [166.5799919861645, -21.97478190656881], [166.57970529158146, -21.98169806247439], [166.57534504390537, -21.984131164623346], [166.5775950859067, -21.99064510783211], [166.5806073745467, -21.991153334897465], [166.58298793867803, -21.993802230995442], [166.58425728353708, -22.005334267200226], [166.58284257172414, -22.008571016916974], [166.57137114147315, -22.010633850877525], [166.5679572916314, -22.00846738607257], [166.56713988344245, -22.00541074455204], [166.56052771338173, -22.004024771040367], [166.55249551583435, -21.996096692955177], [166.55232962255266, -21.991497639143763], [166.55747121897429, -21.98251628145595], [166.56146139325736, -21.981274822944343], [166.56507880197935, -21.98272314889984], [166.56878234668199, -21.980664308542643], [166.56681403197078, -21.976348425883565], [166.5582344457619, -21.976830295830524], [166.54754914686927, -21.96760446576005], [166.54423413461464, -21.971240233904787], [166.53867571288947, -21.97095363828474], [166.5297128362208, -21.96385831222561], [166.52792176883798, -21.959506660138963]]]}, \"bbox\": [166.52792176883798, -22.010633850877525, 166.58892459789297, -21.91382153385084]}], \"bbox\": [166.52792176883798, -22.010633850877525, 166.58892459789297, -21.91382153385084]}", "shape_id": 139, "type": "hotspots"};
    var mapping = {"fields": {"elevation": {"data_source": {"name": "elevation", "type": "layer"}, "description": "Altitude metrics within the shape", "field_type": "JSON", "label": "Altitude", "transformations": [{"chart_options": {"title": "Median Altitude"}, "chart_type": "text", "name": "median"}, {"chart_options": {"title": "Maximum Altitude"}, "chart_type": "text", "name": "max"}, {"chart_options": {"title": "Elevation Distribution", "x_label": "Elevation (m)", "y_label": "Area (ha)"}, "chart_type": "stacked_bar", "data_structure": {"x_field": "altitudes", "y_fields": [{"color": "#4BC0C0", "label": "For\u00eat", "name": "forest"}, {"color": "#FF6384", "label": "Hors-for\u00eat", "name": "non_forest"}]}, "name": "elevation_distribution"}]}, "forest": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "TEXT", "label": "Forest Area", "transformations": [{"chart_options": {"title": "Forest Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "forest_coordinates", "title": "Forest Location"}, "chart_type": "map", "name": "coordinates"}]}, "forest_cover": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "JSON", "label": "Forest Area", "transformations": [{"chart_options": {"categories": ["UM", "Non-UM", "Commune"], "title": "Forest Cover"}, "chart_type": "donut", "layer_params": {"forest_cover": [{"name": "area"}, {"attribute": "cover_type"}], "soil_types": [{"attribute": "soil_category"}]}, "name": "percentage"}]}, "forest_fragmentation": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Analysis of forest fragmentation", "field_type": "JSON", "label": "Forest Fragmentation", "transformations": [{"chart_options": {"bins": [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 7000, 12000, 17000, 27000, 500000], "title": "Forest Fragment Distribution", "x_label": "Area (ha)", "y_label": "Cumulative Area (%)"}, "chart_type": "line", "data_structure": {"color": "#4BC0C0", "x_field": "keys", "y_field": "values"}, "name": "fragment_size_distribution"}, {"chart_options": {"label": "Effective Mesh Size (km\u00b2)", "max": 1000, "min": 0, "title": "Fragmentation"}, "chart_type": "gauge", "name": "effective_mesh_size"}]}, "forest_humidity": {"data_source": [{"name": "forest_cover", "type": "layer"}, {"name": "holdridge", "type": "shape"}], "description": "Distribution of forests by humidity level", "field_type": "JSON", "label": "Forest and Living Environments", "transformations": [{"chart_options": {"categories": ["Dry", "Humid", "Very Humid"], "title": "Forest and Living Environments", "x_label": "Category", "y_label": "Frequency (%)"}, "chart_type": "stacked_bar", "layer_params": {"forest_cover": [{"name": "area"}], "humidity": [{"name": "value"}]}, "name": "category_distribution"}]}, "land_use": {"data_source": [{"name": "ultramafic", "type": "shape"}, {"name": "holdridge", "type": "shape"}, {"name": "forest_cover", "type": "layer"}], "description": "Land use distribution", "field_type": "JSON", "label": "Land Use", "transformations": [{"chart_options": {"title": "Land Use", "x_label": "Category", "y_label": "Area (ha)"}, "chart_type": "bar", "name": "category_distribution"}]}, "num_families": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of families in the zone", "field_type": "INTEGER", "label": "Number of Families", "transformations": [{"chart_options": {"title": "Number of Families"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["family"]}]}, "num_occurrences": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of occurrences in the zone", "field_type": "INTEGER", "label": "Number of Occurrences", "source_field": "id_occurrence", "transformations": [{"chart_options": {"title": "Number of Occurrences"}, "chart_type": "text", "name": "count"}]}, "num_species": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of species in the zone", "field_type": "INTEGER", "label": "Number of Species", "transformations": [{"chart_options": {"title": "Number of Species"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["species", "infra"]}]}, "rainfall": {"data_source": {"name": "rainfall", "type": "layer"}, "description": "Average annual rainfall within the shape", "field_type": "TEXT", "label": "Average Rainfall", "transformations": [{"chart_options": {"title": "Average Rainfall"}, "chart_type": "text", "name": "mean"}, {"chart_options": {"title": "Rainfall Range"}, "chart_type": "text", "name": "range"}]}, "shape": {"data_source": {"name": "self", "type": "shape"}, "description": "Total area of the reference zone", "field_type": "TEXT", "label": "Shape Area", "transformations": [{"chart_options": {"title": "Total Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "shape_coordinates", "title": "Location"}, "chart_type": "map", "name": "coordinates"}]}}, "group_by": "shape", "source_location_field": "geo_pt", "source_table_name": "occurrences"};
    var currentShapeType = "hotspots";

    document.addEventListener('DOMContentLoaded', function () {
        loadShapeCharts(shape, mapping);
        loadShapeTypeList();
        initShapeMaps(mapping, shape);
        loadAllShapesMap(shape);
    });

    function loadShapeCharts(shape, mapping) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            if (field.field_type !== 'TEXT' && shape[field_key] !== null) {
                // Handle bins chart if present
                if (field.bins && field.bins.values && field.bins.values.length > 0) {
                    var binChartId = field_key + 'BinChart';
                    var binCtx = document.getElementById(binChartId);
                    if (binCtx) {
                        createBinChart(binCtx, field, shape);
                    }
                }

                // Handle transformations
                field.transformations.forEach(function(transformation) {
                    var transformationName = transformation.name ? transformation.name : '';
                    var valueKey = field_key + '_' + transformationName;

                    if (shape[valueKey] !== null) {
                        switch(transformation.chart_type) {
                            case 'pie':
                                var pieChartId = field_key + 'PieChart';
                                var pieCtx = document.getElementById(pieChartId);
                                if (pieCtx) {
                                    createPieChart(pieCtx, transformation, shape[valueKey]);
                                }
                                break;
                            case 'gauge':
                                var gaugeId = field_key + transformationName + 'Gauge';
                                var gaugeElement = document.getElementById(gaugeId);
                                if (gaugeElement) {
                                    createGauge({
                                        id: gaugeId,
                                        value: parseFloat(shape[valueKey]),
                                        min: 0,
                                        max: transformation.chart_options.max,
                                        title: transformation.chart_options.title,
                                        label: transformation.chart_options.label
                                    });
                                }
                                break;
                            case 'bar':
                                var barChartId = field_key + transformationName + 'BarChart';
                                var barCtx = document.getElementById(barChartId);
                                if (barCtx) {
                                    createBarChart(barCtx, field, transformation, shape[valueKey]);
                                }
                                break;
                            case 'stacked_bar':
                                if (field_key === 'elevation' && transformationName === 'elevation_distribution') {
                                    var stackedBarChartId = 'elevationDistributionChart';
                                    var stackedBarCtx = document.getElementById(stackedBarChartId);
                                    if (stackedBarCtx) {
                                        createElevationDistributionChart(stackedBarCtx, shape.elevation_elevation_distribution, transformation);
                                    }
                                }
                                break;
                            case 'line':
                                if (field_key === 'forest_fragmentation' && transformationName === 'fragment_size_distribution') {
                                    var lineChartId = 'forestFragmentationChart';
                                    var lineCtx = document.getElementById(lineChartId);
                                    if (lineCtx) {
                                        createForestFragmentationChart(lineCtx, shape.forest_fragmentation_fragment_size_distribution, transformation);
                                    }
                                }
                                break;
                        }
                    }
                });
            }
        });
    }

    function createBinChart(ctx, field, shape) {
        var binData = {
            labels: field.bins.values,
            datasets: [{
                label: field.label,
                data: field.bins.values.map(value => shape.frequencies[field.field_key][value] || 0),
                backgroundColor: field.bins.chart_options.color
            }]
        };

        new Chart(ctx, {
            type: field.bins.chart_type,
            data: binData,
            options: field.bins.chart_options
        });
    }

    function createPieChart(ctx, transformation, data) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['True', 'False'],
                datasets: [{
                    data: [data.true || 0, data.false || 0],
                    backgroundColor: ['#FF6384', '#36A2EB']
                }]
            },
            options: {
                title: {
                    display: true,
                    text: transformation.chart_options.title
                }
            }
        });
    }

    function createBarChart(ctx, field, transformation, data) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: field.label,
                    data: Object.values(data),
                    backgroundColor: getColor(0).background,
                    borderColor: getColor(0).border,
                    borderWidth: 1
                }]
            },
            options: transformation.chart_options
        });
    }

    function createElevationDistributionChart(ctx, elevationData, chartConfig) {
        const altitudes = elevationData.altitudes.reverse();
        const forestData = elevationData.forest.reverse();
        const nonForestData = elevationData.non_forest.reverse();

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: altitudes,
                datasets: [
                    {
                        label: 'Forest',
                        data: forestData,
                        backgroundColor: '#4CAF50',
                        stack: 'Stack 0',
                    },
                    {
                        label: 'Non-Forest',
                        data: nonForestData,
                        backgroundColor: '#FFF59D',
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Area (ha)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString(); // Format les grands nombres
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Elevation (m)'
                        },
                        reverse: false
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 0,
                        bottom: 10
                    }
                }
            }
        });
    }

    function createForestFragmentationChart(ctx, fragmentationData, chartConfig) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(fragmentationData),
                datasets: [{
                    label: 'Cumulative Area (%)',
                    data: Object.values(fragmentationData),
                    borderColor: '#4BC0C0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.x_label
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.y_label
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartConfig.chart_options.title
                    }
                }
            }
        });
    }

    function createGauge(options) {
        new JustGage({
            id: options.id,
            value: options.value || 0,
            min: options.min || 0,
            max: options.max,
            title: options.title,
            label: options.label,
            pointer: true,
            pointerOptions: {
                toplength: 10,
                bottomlength: 10,
                bottomwidth: 2,
                color: '#8e8e93',
                stroke: '#ffffff',
                stroke_width: 3,
                stroke_linecap: 'round'
            },
            gaugeWidthScale: 0.6,
            counter: true,
            donut: true,
            relativeGaugeSize: true,
            donutStartAngle: 270,
            hideInnerShadow: true,
            customSectors: [{
                color: "#ff0000",
                lo: 0,
                hi: options.max * 0.33
            }, {
                color: "#ffff00",
                lo: options.max * 0.33,
                hi: options.max * 0.66
            }, {
                color: "#00ff00",
                lo: options.max * 0.66,
                hi: options.max
            }],
            humanFriendly: true,
            formatNumber: true,
            textRenderer: function (val) {
                return parseFloat(val).toFixed(2);
            }
        });
    }

    // Function to get a color based on the index
    function getColor(index) {
        var colors = [
            {background: 'rgba(54, 162, 235, 0.6)', border: 'rgba(54, 162, 235, 1)'},
            {background: 'rgba(75, 192, 192, 0.6)', border: 'rgba(75, 192, 192, 1)'},
            {background: 'rgba(255, 99, 132, 0.6)', border: 'rgba(255, 99, 132, 1)'}
        ];
        return colors[index % colors.length];
    }

// Rest of the code (loadShapeTypeList, initShapeMaps, loadAllShapesMap) remains the same...

    let maps = {};  // Object to keep track of initialized maps

    function initMap(field_key, geometry) {
        const mapId = field_key + 'Map';
        const mapLoaderId = field_key + 'MapLoader';

        // Check if the map already exists
        if (maps[mapId]) {
            return; // Map is already initialized, so do nothing
        }

        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        map.on('load', function () {
            document.getElementById(mapLoaderId).style.display = 'none';
        });

        if (geometry) {
            const geoJsonLayer = L.geoJSON(geometry, {
                style: function() {
                    return {
                        color: '#228b22', // Border color
                        weight: 2,       // Border width
                        fillColor: '#228b22cc', // Fill color with opacity
                        fillOpacity: 0.8 // Fill opacity
                    };
                }
            }).addTo(map);
            map.fitBounds(geoJsonLayer.getBounds());
        } else {
            console.warn("No geographic coordinates found.");
            // Set default view if no geometry is found
            map.setView([-21.291237, 165.516418], 10);
        }

        // Store the map instance in the maps object
        maps[mapId] = map;
    }

    function initShapeMaps(mapping, shape) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            field.transformations.forEach(function(transformation) {
                if (transformation.chart_type === 'map') {
                    var coordinatesField = transformation.chart_options.coordinates_field;
                    var geometry = shape[coordinatesField];

                    // Check if geometry is a string, if so, parse it as JSON
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.error("Invalid JSON for field", coordinatesField, ":", geometry);
                            return; // Skip this field if JSON is invalid
                        }
                    }

                    // Initialize the map with the parsed geometry
                    initMap(field_key, geometry);
                }
            });
        });
    }

    function loadAllShapesMap(currentShape) {
        const mapId = 'allShapesMap';
        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        var group = L.featureGroup(); // Create a group to hold all the layers

        shapeTypes.forEach(function(shapeTypeItem) {
            if (shapeTypeItem.type === currentShape.type) {
                shapeTypeItem.shapes.forEach(function(shapeItem) {
                    var geometry = shapeItem.geometry;
                    // No need to parse geometry if it's already GeoJSON
                    var layer = L.geoJSON(geometry, {
                        style: function() {
                            return {
                                color: '#228b22', // Border color
                                weight: 2,       // Border width
                                fillColor: '#228b22cc', // Fill color with opacity
                                fillOpacity: 0.8 // Fill opacity
                            };
                        }
                    }).addTo(map);
                    group.addLayer(layer); // Add each layer to the group

                    // Highlight current shape
                    if (shapeItem.id === currentShape.id) {
                        layer.setStyle({color: 'red', weight: 3, fillOpacity: 0.4});
                        layer.bringToFront(); // Ensure the highlighted shape is on top
                    } else {
                        layer.setStyle({fillOpacity: 0.2}); // Reduce opacity for other shapes
                    }

                    // Show tooltip on hover with additional content
                    var tooltipContent = "<strong>" + shapeItem.name + "</strong><br>";

                    


                    layer.bindTooltip(tooltipContent, {
                        permanent: false,
                        direction: 'right',
                        offset: L.point(10, 0),
                        opacity: 0.9,
                        className: 'custom-tooltip'
                    });


                    layer.on('mousemove', function(e) {
                        var tooltip = e.target.getTooltip();
                        tooltip.setLatLng(e.latlng);
                    });

                    layer.on('click', function() {
                        window.location.href = '../shape/' + shapeItem.id + '.html';
                    });
                });
            }
        });

        map.fitBounds(group.getBounds()); // Adjust the view to fit the bounds of the group

        map.attributionControl.setPrefix(false);
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        maps['allShapesMap'] = map;
    }

    function loadShapeTypeList() {
            var shapeTypeListElement = document.getElementById("shape-type-list");
            shapeTypes.forEach(function (shapeTypeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "javascript:void(0)";
                a.textContent = shapeTypeItem.type;
                a.className = "shape-type-link";
                if (shapeTypeItem.type === currentShapeType) {
                    a.classList.add("active");
                }
                a.onclick = function () {
                    if (shapeTypeItem.shapes.length > 0) {
                        // Redirect to the first shape of the selected type
                        window.location.href = "../shape/" + shapeTypeItem.shapes[0].id + ".html";
                    }
                    loadShapeList(shapeTypeItem.shapes);
                };
                li.appendChild(a);
                shapeTypeListElement.appendChild(li);
            });
        }

        function loadShapeList(shapes) {
            var shapeListElement = document.getElementById("shape-list");
            shapeListElement.innerHTML = ''; // Clear the previous list
            shapes.forEach(function (shapeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "../shape/" + shapeItem.id + ".html";
                a.textContent = shapeItem.name;
                a.className = "shape-link";
                if (shapeItem.id === shape.id) {
                    a.classList.add("active");
                }
                li.appendChild(a);
                shapeListElement.appendChild(li);
            });
        }

</script>

</body>
</html>