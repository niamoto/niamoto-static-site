<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Niamoto - Cap Bocage</title>
    <link rel="stylesheet" href="../js/vendor/tailwindcss/2.2.19_dist_tailwind.css">
    <link rel="stylesheet" href="../js/vendor/leaflet/1.9.4_leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
<script src="../js/shape_list.js"></script>

<style>
    #shape-type-list li, #shape-list li {
        list-style: none;
        text-transform: capitalize;
    }

    .shape-type-link, .shape-link {
        display: block;
        padding: 10px;
        border-radius: 5px;
        text-decoration: none;
    }

    .shape-type-link:hover, .shape-link:hover {
        background-color: #f0f0f0;
    }

    .shape-type-link.active, .shape-link.active {
        background-color: #3498db;
        color: #fff;
    }

    #shapeMap, #allShapesMap {
        position: relative;
        height: 300px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #allShapesMap {
        height: 400px;
    }

    .chart-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .chart-container > div {
        flex: 1 1 calc(33.333% - 10px);
        margin: 5px;
    }
    .custom-tooltip {
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    font-size: 12px;
    max-width: 300px;
    word-wrap: break-word;
}
</style>

    <style>
        .gauge {
            height: 349px;
        }

        ul {
            list-style-type: none;
        }

        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bg p-4 fixed w-full top-0 shadow-md z-50 custom-nav">
    <div class="container mx-auto flex flex-wrap items-center justify-between">
        <div class="flex items-center flex-shrink-0 text-white mr-6">
            <a id="home-link" class="inline-flex items-center py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                <span class="site-title">Niamoto</span>
            </a>
        </div>

        <div class="block lg:hidden">
            <button id="nav-toggle"
                class="flex items-center px-3 py-2 border rounded text-teal-200 border-teal-400 hover:text-white hover:border-white">
                <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <title>Menu</title>
                    <path d="M0 3h20v2H0zm0 6h20v2H0zm0 6h20v2H0z" />
                </svg>
            </button>
        </div>
        <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block pt-6 lg:pt-0" id="nav-content">
            <ul class="list-reset lg:flex justify-end flex-1 items-center">
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                        <i class="fas fa-home menu-icon"></i>Accueil
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#introduction">Introduction</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#project">Projet</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#objective">Objectifs</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#context">Contexte</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#flora">Flore</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="methodology.html">
                        <i class="fas fa-flask menu-icon"></i>Méthodologie
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#methodes">Nos méthodes</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#faq">FAQ</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="trees.html">
                        <i class="fas fa-leaf menu-icon"></i>Arbres
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#learnTaxon">Étudier les
                arbres</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#taxon">Les arbres de
                Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="plots.html">
                        <i class="fas fa-map-marked-alt menu-icon"></i>Peuplements
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#learnPlot">Étudier les
                            peuplements forestiers</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#plot">Les
                peuplements forestiers de Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="forests.html">
                        <i class="fas fa-tree menu-icon"></i>Forêt
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#learnForest">Étudier les
                forêts</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPN">La forêt de la
                province Nord</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPS">La forêt de la
                province Sud</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="resources.html">
                        <i class="fas fa-book menu-icon"></i>Ressources
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#equipe">L'équipe</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#article">Articles</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#academic">Académique</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#media-production">Médias</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
  document.getElementById('nav-toggle').onclick = function () {
    document.getElementById('nav-content').classList.toggle('hidden');
  };

  // Function to adjust the navigation links based on page depth
  function adjustNavLinks(depth) {
    document.querySelectorAll('a[data-link]').forEach(link => {
      link.href = depth + link.getAttribute('data-link');
    });
  }

  // Adjust the navigation links based on the depth
  adjustNavLinks("../");
</script>

<style>
    .site-title {
        font-family: 'Arial Black', sans-serif; /* Custom font for a bold effect */
        font-size: 2rem; /* Increased font size */
        text-transform: uppercase; /* Uppercase letters for visibility */
        letter-spacing: 2px; /* Spacing between letters */
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7); /* Text shadow for better visibility */
        transition: color 0.3s; /* Smooth transition for hover effect */
    }

    .site-title:hover {
        color: #ffdd57; /* Change color on hover */
    }

    .text-contour {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .nav-bg {
        background-color: rgba(34, 139, 34, 0.8); /* Fond vert semi-transparent */
        transition: background-color 0.3s;
    }

    .nav-bg:hover {
        background-color: rgba(34, 139, 34, 1); /* Fond vert opaque au survol */
    }

    .group:hover .group-hover\:block {
        display: block;
    }

    .custom-nav {
        z-index: 500;
    }

    .custom-dropdown {
        z-index: 500;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2); /* Fond blanc transparent au survol */
        border-radius: 4px;
    }

    .menu-icon {
        margin-right: 8px;
    }
</style>
    <div class="flex">
        
<aside class="w-1/4 p-4 mt-28">
    <h2 class="font-semibold text-lg mb-4">Shape Types</h2>
    <ul id="shape-type-list" class="list-disc pl-5">
        <!-- The list of shape types will be generated by JavaScript -->
    </ul>
</aside>

        <div class="w-full">
            
<div id="allShapesMap" class="mt-28"></div>

<div class="rounded overflow-hidden shadow-lg mb-2 mt-8">
    <div class="px-6 py-4">
        <div class="font-bold text-4xl mb-2">Cap Bocage</div>
    </div>
</div>

<div class="chart-container">
    <!-- Section for general information -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">General Information</h2>
            
                
                    
                        
                        
                            <p>Shape Area (Total Area): 5493.239884681983</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Forest Area (Forest Area): 516.9929463329737</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Number of Families (Number of Families): 47</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Species (Number of Species): 121</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Occurrences (Number of Occurrences): 470</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Average Rainfall (Average Rainfall): 1845.3333740234375</p>
                        
                    
                
                    
                        
                        
                            <p>Average Rainfall (Rainfall Range): {"min": 1580.0, "max": 2160.0}</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Altitude (Median Altitude): 106.0</p>
                        
                    
                
                    
                        
                        
                            <p>Altitude (Maximum Altitude): 404.0</p>
                        
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        </div>
    </div>

    <!-- Section for shape map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Shape Map</h2>
            <div id="shapeMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="shapeMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Section for forest map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Forest Map</h2>
            <div id="forestMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="forestMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div class="flex flex-wrap -mx-2">
    

    

    
    
        
    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
    
        
            
            

            
            
                
            
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Elevation Distribution</h2>
        
    
    
        <canvas id="elevationDistributionChart"></canvas>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Forest Fragment Distribution</h2>
        
    
    
        <canvas id="forestFragmentationChart"></canvas>
    
    
                        </div>
                    </div>
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Fragmentation</h2>
        
    
    
        <div class="gauge" id="forest_fragmentationeffective_mesh_sizeGauge"></div>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
</div>

        </div>
    </div>
    <footer class="bg-green-700 text-white p-4 mt-8">
        <div class="container mx-auto">
            <div class="flex justify-center mb-4">
                <div class="bg-white p-2 rounded-lg shadow-md flex justify-center">
                    <figure class="mx-2"><img class="img-fluid" src="../files/ps_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/pn_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/amap_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/herbarium_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/iac_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/ird_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/cirad_100.png"></figure>
                </div>
            </div>
            <div class="text-center">
                <p>Niamoto - Portail de la forêt de Nouvelle-Calédonie</p>
                <a class="inline-block py-2 px-4 text-white no-underline" href="https://github.com/niamoto/niamoto" target="_blank">
                    <span class="fab fa-github fa-lg" aria-hidden="true"></span> Github
                </a>
            </div>
        </div>
    </footer>
    <script src="../js/vendor/chart/4.4.2_chart.js"></script>
    <script src="../js/vendor/d3/7.8.5_d3.js"></script>
    <script src="../js/vendor/jquery/3.6.0_jquery.js"></script>
    <script src="../js/vendor/raphael/2.3.0_raphael.js"></script>
    <script src="../js/vendor/justgage/1.6.1_justgage.js"></script>
    <script src="../js/vendor/leaflet/1.9.4_leaflet.js"></script>
    
<script>
    var shape = {"elevation_elevation_distribution": {"altitudes": [-3.0, 97.0, 197.0, 297.0, 397.0], "forest": [423.3980596456634, 71.12198377249989, 15.55793395023435, 0.0, 0.0], "non_forest": [1413.5494274784353, 859.0202102522252, 715.6649617107802, 338.94070391581977, 2.2225619928906215]}, "elevation_max": 404.0, "elevation_median": 106.0, "forest_area": "516.9929463329737", "forest_coordinates": "{\"type\": \"MultiPolygon\", \"coordinates\": [[[[165.5283055148708, -21.1782805072993], [165.52873896409977, -21.177390744475765], [165.5291586351146, -21.1772890299321], [165.52809720377917, -21.178956096864987], [165.5283055148708, -21.1782805072993]]], [[[165.52829121207424, -21.17718091988899], [165.5286079794719, -21.177276241481806], [165.5276143110778, -21.17826408819052], [165.5273188699862, -21.177716152194833], [165.52829121207424, -21.17718091988899]]], [[[165.52280167644662, -21.17193505086564], [165.5222606579269, -21.170249698489396], [165.52537418447147, -21.173073316151555], [165.52190084914105, -21.172974113681626], [165.52280167644662, -21.17193505086564]]], [[[165.5130867281283, -21.171369187085126], [165.5134408947052, -21.171661879562613], [165.5145473984087, -21.172144058003436], [165.51289863833858, -21.17195794637939], [165.5130867281283, -21.171369187085126]]], [[[165.51136878871188, -21.169461128679043], [165.51305520586874, -21.170768294963842], [165.51174074130836, -21.171827243252427], [165.51055174975747, -21.16965701887358], [165.51136878871188, -21.169461128679043]]], [[[165.5041902978962, -21.16865436607025], [165.50640529088147, -21.170239902369275], [165.50645924804314, -21.17087694338074], [165.50330276419788, -21.169109589335655], [165.5041902978962, -21.16865436607025]]], [[[165.50452189429055, -21.164470599768315], [165.5140817350374, -21.16947281998162], [165.51686424614263, -21.172030566484796], [165.50626915569418, -21.166486687698946], [165.50349364381094, -21.163573220416147], [165.50452189429055, -21.164470599768315]]], [[[165.5201210715644, -21.164250127556024], [165.52086135971723, -21.16504683853494], [165.5206807966787, -21.16539423044929], [165.51965256060356, -21.164915424737], [165.5201210715644, -21.164250127556024]]], [[[165.52220192705386, -21.16394096152739], [165.5225110650541, -21.16418440794674], [165.5226518506203, -21.16534646735955], [165.52116173503873, -21.164521727057874], [165.52220192705386, -21.16394096152739]]], [[[165.5262244267678, -21.162243981466055], [165.528379182205, -21.16332198281465], [165.5268232594202, -21.16634009228315], [165.52457350379845, -21.162513229148324], [165.5262244267678, -21.162243981466055]]], [[[165.51050853618466, -21.164385169164344], [165.5135830866244, -21.161403898561407], [165.5171634128314, -21.163177872399398], [165.51276043542302, -21.163536514692467], [165.51162547584553, -21.165807624511377], [165.51050853618466, -21.164385169164344]]], [[[165.5270947174752, -21.16150296815619], [165.52760110980722, -21.161531845301415], [165.528154065113, -21.16207519452355], [165.5264110349603, -21.16180336005056], [165.5270947174752, -21.16150296815619]]], [[[165.52928933792123, -21.16051811452128], [165.52984410671002, -21.15957246149726], [165.53149140557537, -21.160287086159226], [165.53075788678754, -21.16182216251822], [165.52928933792123, -21.16051811452128]]], [[[165.50017119731007, -21.151254294304294], [165.50278562558074, -21.154259525049202], [165.5047292229847, -21.15385937777986], [165.5026858587496, -21.156380003683946], [165.50408689519202, -21.157371665765496], [165.5044313402044, -21.155950754764905], [165.50513216195563, -21.157711642645033], [165.50252667597258, -21.15730858397496], [165.50247048198622, -21.15571522794451], [165.50294912127276, -21.155044941320465], [165.50017119731007, -21.151254294304294]]], [[[165.50958394880792, -21.1489428784881], [165.5103528160334, -21.150186605924667], [165.5120548317798, -21.14950054961901], [165.51145734904773, -21.150571482206246], [165.51318887450154, -21.150887753670798], [165.51189086587888, -21.15172327390499], [165.5149817184072, -21.153604011631273], [165.51798844932762, -21.152603239716438], [165.5178570733546, -21.15371847526763], [165.51657309275487, -21.154440100533378], [165.51200812314377, -21.153184080582527], [165.50814638020375, -21.15004404099942], [165.50958394880792, -21.1489428784881]]], [[[165.50496440296064, -21.150144306057854], [165.50548299262724, -21.15000619884742], [165.50634779819984, -21.150006482439217], [165.50451212508213, -21.150649301078083], [165.50496440296064, -21.150144306057854]]], [[[165.49971950820137, -21.14973650096497], [165.4996979235453, -21.149788064573222], [165.49965576960713, -21.149826411940122], [165.49971950820137, -21.14973650096497]]], [[[165.50396405230623, -21.14603283478318], [165.5047168054241, -21.14793405455643], [165.5025040078711, -21.147982561808217], [165.50204593889302, -21.14700266300923], [165.50396405230623, -21.14603283478318]]], [[[165.53363061239773, -21.181208817641245], [165.53371634649721, -21.181849293939162], [165.534180098891, -21.182267466197008], [165.5331364231862, -21.18210943807129], [165.53363061239773, -21.181208817641245]]], [[[165.53572155478346, -21.182038636184974], [165.5348094914933, -21.181227497070605], [165.53745488641093, -21.18249547609884], [165.53549431280132, -21.18246645785705], [165.53572155478346, -21.182038636184974]]], [[[165.53332179848744, -21.181026691408203], [165.53383009588882, -21.180768695845334], [165.53280129795624, -21.182058695094586], [165.53246814599203, -21.18193882582829], [165.53332179848744, -21.181026691408203]]], [[[165.5502533643427, -21.181078474919588], [165.5506212830321, -21.180890730543695], [165.5506224009258, -21.180962736633795], [165.54984455569604, -21.181331814469747], [165.5502533643427, -21.181078474919588]]], [[[165.53157574254467, -21.17955243249266], [165.53239270366933, -21.181339744819493], [165.5321207464357, -21.181724774454395], [165.5314497533315, -21.18063313833314], [165.53157574254467, -21.17955243249266]]], [[[165.55247063149403, -21.180184455763698], [165.55218234395556, -21.18018555723962], [165.5522485777117, -21.180161494758565], [165.55247063149403, -21.180184455763698]]], [[[165.55623741770313, -21.18017006379817], [165.55610622215474, -21.180170565064156], [165.556119908652, -21.180124133687574], [165.55623741770313, -21.18017006379817]]], [[[165.53005903746026, -21.178443142387685], [165.53139194112333, -21.1796198737276], [165.52993490450635, -21.180491999739555], [165.5294710334417, -21.179023523983084], [165.53005903746026, -21.178443142387685]]], [[[165.53401232542535, -21.17523078672631], [165.533159207571, -21.175812031857856], [165.53269983641866, -21.17521203688336], [165.5337217028596, -21.174818290181342], [165.53401232542535, -21.17523078672631]]], [[[165.54287474476448, -21.173674370836068], [165.54301319378342, -21.17298590129851], [165.54385059913574, -21.172433354413695], [165.5423224542845, -21.174749933286254], [165.54287474476448, -21.173674370836068]]], [[[165.53311233296353, -21.172530809341065], [165.53275608594743, -21.17384329834778], [165.53198734238634, -21.17119019556992], [165.53301858374877, -21.17197768897395], [165.53311233296353, -21.172530809341065]]], [[[165.53356379342185, -21.17102070762096], [165.53109341849492, -21.168749803961433], [165.5319168768039, -21.16652493213284], [165.5375935454293, -21.17389954787664], [165.54096851716085, -21.1727558074565], [165.5341529492474, -21.176562025575976], [165.5354935630186, -21.172999555414894], [165.53356379342185, -21.17102070762096]]], [[[165.5431294365612, -21.167430852057837], [165.54372005661423, -21.167965222582], [165.5423700679216, -21.16834021944106], [165.54236069300012, -21.167430852057837], [165.5431294365612, -21.167430852057837]]], [[[165.54450755001827, -21.16680273231891], [165.54506067038537, -21.16601523891488], [165.54578253933906, -21.168012097189383], [165.54457317446858, -21.167402727293407], [165.54450755001827, -21.16680273231891]]], [[[165.54390755504377, -21.16531211980414], [165.54448880017532, -21.165349619490044], [165.543813805829, -21.16625898687327], [165.54340130928404, -21.16574336619206], [165.54390755504377, -21.16531211980414]]], [[[165.54177007294712, -21.16458087592897], [165.5421825694921, -21.163802757446415], [165.54436692619612, -21.16406525524776], [165.54394505472968, -21.16441212734239], [165.54177007294712, -21.16458087592897]]], [[[165.5413744738712, -21.16129517634891], [165.54154520352128, -21.162075064570455], [165.53999916236734, -21.16199075314552], [165.5402427042156, -21.161100617321683], [165.5413744738712, -21.16129517634891]]], [[[165.53474369229824, -21.15521045027136], [165.53545481241406, -21.155108878102297], [165.53641988433637, -21.15577619176424], [165.53369433632164, -21.156497749445315], [165.53474369229824, -21.15521045027136]]], [[[165.60826057451294, -21.203936516474513], [165.6084054508462, -21.205239902253275], [165.60791817482837, -21.205520968241643], [165.60744065513583, -21.203833238660827], [165.60826057451294, -21.203936516474513]]], [[[165.61026389915668, -21.20708691655194], [165.61259031065617, -21.20527546542745], [165.6105229930554, -21.204836006755716], [165.61038400383947, -21.20123006261733], [165.61304303105373, -21.204628244545983], [165.61208205932948, -21.200944805306115], [165.61578935637297, -21.2026037853674], [165.61649647861327, -21.20091226852038], [165.61806640264734, -21.20124864873568], [165.61851035631975, -21.203916845814163], [165.61669764360337, -21.203742934250233], [165.6180843451766, -21.204822315861342], [165.61088937184195, -21.20825051908125], [165.60834032909122, -21.20732172028426], [165.61026389915668, -21.20708691655194]], [[165.61215697731865, -21.20676851224847], [165.61265401924018, -21.206674730753846], [165.6129072292757, -21.206074529188214], [165.61165055724769, -21.20635587367211], [165.61215697731865, -21.20676851224847]]], [[[165.60758986773496, -21.20220157924693], [165.60741138338452, -21.20335469565847], [165.6064085083444, -21.203617324221767], [165.60725235233974, -21.20240779122664], [165.60758986773496, -21.20220157924693]]], [[[165.60503926008212, -21.19909720715794], [165.6063142003839, -21.19945347156356], [165.60425142127423, -21.200447474637308], [165.60507624200423, -21.199276565898675], [165.60503926008212, -21.19909720715794]]], [[[165.56913725864416, -21.190230321696074], [165.56947947505574, -21.188577702550898], [165.56987686131077, -21.191045105739256], [165.5735379047306, -21.189390091469885], [165.57758771043885, -21.191019321444898], [165.5805595969403, -21.189061160080968], [165.57979734279482, -21.19086875179492], [165.58236113698345, -21.19272250953735], [165.58457258934754, -21.190901699657108], [165.58678422022334, -21.191547271287785], [165.58917754509312, -21.194733496297985], [165.59474799513643, -21.195033781395356], [165.5961820434218, -21.198478106672475], [165.59992305214047, -21.198004590589505], [165.6023560170377, -21.201134325655048], [165.59909428662561, -21.20371651433254], [165.6014534284936, -21.203044523218427], [165.59907834903026, -21.20581394354008], [165.59711148229988, -21.204087526099226], [165.59876719399256, -21.203565862524613], [165.5974478194475, -21.20094484679381], [165.596887513465, -21.203771908455323], [165.59374752591788, -21.20319828054376], [165.59166677675984, -21.19851071777892], [165.58804617641948, -21.200622100420798], [165.58334522074887, -21.1984522678308], [165.58409426868477, -21.197631953423702], [165.5832880507314, -21.193805364729524], [165.58296027043156, -21.196045424183538], [165.5789428718816, -21.19604248746146], [165.57684949972926, -21.194967898990782], [165.5794434543995, -21.19520625446458], [165.57912332140938, -21.1920457615924], [165.5760641571771, -21.19456573052786], [165.57312748691345, -21.193352531242322], [165.57406958800118, -21.191293477570763], [165.57263328112182, -21.19308385920578], [165.56937932102682, -21.1918683619092], [165.56913725864416, -21.190230321696074]], [[165.59455151953253, -21.201976700338353], [165.59429904816756, -21.20240683673794], [165.59435515291534, -21.2015091607736], [165.5945702211151, -21.201752281347282], [165.59455151953253, -21.201976700338353]], [[165.58086939808538, -21.19471414491334], [165.58041933037575, -21.19491104953631], [165.58036307191202, -21.195032942874345], [165.5809819150128, -21.19524860031856], [165.58086939808538, -21.19471414491334]], [[165.5950504168917, -21.20068775835973], [165.59541658578362, -21.200884926224617], [165.59595175570263, -21.200284033683992], [165.59424296754025, -21.200368534197523], [165.5950504168917, -21.20068775835973]], [[165.5909995600476, -21.19836989502159], [165.5908687113395, -21.19542579908908], [165.587447952256, -21.198257738986058], [165.58960695593987, -21.199463416367948], [165.5909995600476, -21.19836989502159]], [[165.59381107602664, -21.19781474089988], [165.59378290918877, -21.198312355035082], [165.59490958270246, -21.197044847332204], [165.5934073513509, -21.197157514683575], [165.59381107602664, -21.19781474089988]]], [[[165.60486155078607, -21.195748954533137], [165.60450437587167, -21.196752411805285], [165.603791943259, -21.195664814430415], [165.604529673863, -21.19535521473141], [165.60486155078607, -21.195748954533137]]], [[[165.6122784264776, -21.191680989438105], [165.6135360704629, -21.19268670334074], [165.6140029243946, -21.193818582517835], [165.6123624797199, -21.192899891859984], [165.61149351386172, -21.19038602738888], [165.6122784264776, -21.191680989438105]]], [[[165.59220367605127, -21.18975192081486], [165.59408842288346, -21.19055902367179], [165.59304155574245, -21.19220985494423], [165.5917837994605, -21.1906634815475], [165.59220367605127, -21.18975192081486]]], [[[165.56451048385125, -21.184749582970916], [165.56740696832304, -21.183671594553438], [165.56844735765094, -21.1847305946341], [165.5654666041893, -21.18580854076516], [165.56310442850778, -21.18498375989064], [165.56451048385125, -21.184749582970916]]], [[[165.57692134102345, -21.18312447060955], [165.5767807172013, -21.182243227990757], [165.57801820683622, -21.18103386312028], [165.57745571154763, -21.182299477519614], [165.5798275666812, -21.183002596630356], [165.57692134102345, -21.18312447060955]]], [[[165.55687889454316, -21.180167612872616], [165.55639382293518, -21.180169466212167], [165.55659676984976, -21.179694026532857], [165.55691439854937, -21.17976867571712], [165.55687889454316, -21.180167612872616]]], [[[165.59914226815846, -21.17726980667494], [165.60144185077945, -21.1773737224468], [165.60457267001104, -21.179192336563073], [165.59687673794096, -21.176605048827714], [165.59914226815846, -21.17726980667494]]], [[[165.54436981349355, -21.17445546349922], [165.54785941253186, -21.171957783860602], [165.54779823564263, -21.173910129038937], [165.54950189409172, -21.17206947569284], [165.5507588988405, -21.17326367130514], [165.55311626584384, -21.171966494993388], [165.55693076043968, -21.173330826494627], [165.5592056571225, -21.1722195884383], [165.56060296616826, -21.174012307634687], [165.56333676457785, -21.171798373319074], [165.5704840544122, -21.175677064112158], [165.56884878953827, -21.176545926911796], [165.5646433275835, -21.174537436231674], [165.5644320014679, -21.176877574254252], [165.5674184646518, -21.17824813337399], [165.56291193304972, -21.18019298966214], [165.5684232153163, -21.179919347463237], [165.5618455217856, -21.18111692581677], [165.56036179963428, -21.180708131920113], [165.56371345882116, -21.17609037978984], [165.55988996030493, -21.178997715443348], [165.56032026454776, -21.176667815641085], [165.55747192963796, -21.17894662677908], [165.55563522849576, -21.177169955827402], [165.55510722329961, -21.179640324517994], [165.55230903747724, -21.17563907935748], [165.55040921787992, -21.176717508295148], [165.54909384378405, -21.175721039021248], [165.5491907019423, -21.178954861767952], [165.54771756993995, -21.17614732398018], [165.54667318893104, -21.178046762385843], [165.54468598517994, -21.178457321286594], [165.54672127893522, -21.18111718687798], [165.54690938816523, -21.179637870638533], [165.5479609246153, -21.181523394210625], [165.54887269186324, -21.179852860749136], [165.54890231125643, -21.181450132815367], [165.54669419196748, -21.182218208300117], [165.54427741409287, -21.17832199038504], [165.54436981349355, -21.17445546349922]], [[165.56072443050863, -21.17466160019407], [165.56047092896807, -21.175196770113065], [165.56050848475184, -21.175393937977944], [165.5609967099411, -21.175328215356327], [165.56072443050863, -21.17466160019407]], [[165.54618922695417, -21.177262558945362], [165.54686248392738, -21.177458925562558], [165.54662871414502, -21.176205919529018], [165.54617052537156, -21.176336830607152], [165.54618922695417, -21.177262558945362]], [[165.55830208245428, -21.17587277422126], [165.5594850896436, -21.175553550059057], [165.5584335276975, -21.17416398605887], [165.557813857265, -21.175102880653586], [165.55830208245428, -21.17587277422126]]], [[[165.5951779510977, -21.17509336751319], [165.59294325690973, -21.17585041755882], [165.59164576911726, -21.173502183427402], [165.59283771460636, -21.173793482886605], [165.5951779510977, -21.17509336751319]]], [[[165.56435277626943, -21.168815736687478], [165.56527814340362, -21.16947106073743], [165.56385784390852, -21.17065781168457], [165.5631290750557, -21.169050485844974], [165.56435277626943, -21.168815736687478]]], [[[165.57929660158956, -21.16655450936548], [165.58465793963464, -21.170604909474335], [165.58968286506348, -21.172943391399656], [165.58332695902334, -21.171112389408407], [165.58222342268547, -21.168950381832442], [165.5796183849114, -21.16937026295023], [165.57706611898374, -21.16627219372387], [165.57929660158956, -21.16655450936548]]]]}", "forest_cover_percentage": null, "forest_fragmentation_effective_mesh_size": 0.9498514269929689, "forest_fragmentation_fragment_size_distribution": {"10": 18.955318283571643, "100": 41.92571549375734, "1000": 100.0, "1100": 100.0, "1200": 100.0, "12000": 100.0, "125": 41.92571549375734, "1300": 100.0, "1400": 100.0, "150": 67.61470062299712, "1500": 100.0, "1600": 100.0, "1700": 100.0, "17000": 100.0, "175": 100.0, "1800": 100.0, "1900": 100.0, "20": 29.39527824234907, "200": 100.0, "2000": 100.0, "225": 100.0, "250": 100.0, "27000": 100.0, "275": 100.0, "30": 33.8670172454992, "300": 100.0, "325": 100.0, "350": 100.0, "375": 100.0, "40": 33.8670172454992, "400": 100.0, "425": 100.0, "450": 100.0, "475": 100.0, "50": 41.92571549375734, "500": 100.0, "500000": 100.0, "60": 41.92571549375734, "600": 100.0, "70": 41.92571549375734, "700": 100.0, "7000": 100.0, "80": 41.92571549375734, "800": 100.0, "90": 41.92571549375734, "900": 100.0}, "forest_humidity_category_distribution": null, "frequencies": {}, "id": 119, "land_use_category_distribution": null, "name": "Cap Bocage", "num_families_unique_taxonomic_count": 47, "num_occurrences_count": 470, "num_species_unique_taxonomic_count": 121, "rainfall_mean": "1845.3333740234375", "rainfall_range": "{\"min\": 1580.0, \"max\": 2160.0}", "shape_area": "5493.239884681983", "shape_coordinates": "{\"type\": \"FeatureCollection\", \"features\": [{\"id\": \"0\", \"type\": \"Feature\", \"properties\": {}, \"geometry\": {\"type\": \"Polygon\", \"coordinates\": [[[165.61893943736948, -21.188341899306806], [165.62250850137156, -21.19092877539457], [165.62446784926937, -21.196196125411873], [165.62424892547517, -21.207129113707087], [165.6208505923693, -21.211717321465716], [165.6152242500699, -21.21355366749887], [165.60655308558793, -21.213720573142044], [165.60085753000217, -21.212106468930973], [165.5985219291055, -21.20986879047843], [165.58622180898487, -21.209938946177807], [165.57820805978943, -21.205467908550887], [165.57516378026392, -21.20127163255473], [165.5716099720374, -21.20089803868413], [165.5667248408305, -21.19771252252476], [165.5649735932801, -21.193515071891312], [165.55932916393985, -21.18813759401912], [165.55868255641775, -21.18016072152331], [165.55161434739807, -21.18018772741505], [165.54528385320236, -21.182517060747436], [165.53267851307314, -21.182040103625173], [165.52787374557803, -21.17874524502772], [165.52605345696654, -21.173441673156585], [165.50870166251795, -21.17148419279921], [165.5031850806614, -21.169033490303814], [165.50034768193083, -21.163964257395264], [165.49879251110394, -21.15247665831756], [165.50119588910886, -21.147653887618254], [165.50893580450827, -21.144705800664905], [165.52369401813542, -21.149521230273795], [165.5340081881696, -21.14955037526461], [165.53702593158675, -21.15094863464014], [165.54381169854804, -21.14391184417504], [165.55112234443268, -21.13955836398754], [165.56285755652283, -21.138855952340457], [165.5707872976649, -21.144695044516318], [165.57244351095164, -21.150982859369854], [165.57765946621532, -21.15262334160423], [165.58651540442895, -21.162767057215856], [165.60562425020987, -21.16960185872203], [165.61490971908103, -21.175394586110585], [165.61842736230466, -21.179894982878604], [165.61893943736948, -21.188341899306806]]]}, \"bbox\": [165.49879251110394, -21.213720573142044, 165.62446784926937, -21.138855952340457]}], \"bbox\": [165.49879251110394, -21.213720573142044, 165.62446784926937, -21.138855952340457]}", "shape_id": 119, "type": "mines"};
    var mapping = {"fields": {"elevation": {"data_source": {"name": "elevation", "type": "layer"}, "description": "Altitude metrics within the shape", "field_type": "JSON", "label": "Altitude", "transformations": [{"chart_options": {"title": "Median Altitude"}, "chart_type": "text", "name": "median"}, {"chart_options": {"title": "Maximum Altitude"}, "chart_type": "text", "name": "max"}, {"chart_options": {"title": "Elevation Distribution", "x_label": "Elevation (m)", "y_label": "Area (ha)"}, "chart_type": "stacked_bar", "data_structure": {"x_field": "altitudes", "y_fields": [{"color": "#4BC0C0", "label": "For\u00eat", "name": "forest"}, {"color": "#FF6384", "label": "Hors-for\u00eat", "name": "non_forest"}]}, "name": "elevation_distribution"}]}, "forest": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "TEXT", "label": "Forest Area", "transformations": [{"chart_options": {"title": "Forest Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "forest_coordinates", "title": "Forest Location"}, "chart_type": "map", "name": "coordinates"}]}, "forest_cover": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "JSON", "label": "Forest Area", "transformations": [{"chart_options": {"categories": ["UM", "Non-UM", "Commune"], "title": "Forest Cover"}, "chart_type": "donut", "layer_params": {"forest_cover": [{"name": "area"}, {"attribute": "cover_type"}], "soil_types": [{"attribute": "soil_category"}]}, "name": "percentage"}]}, "forest_fragmentation": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Analysis of forest fragmentation", "field_type": "JSON", "label": "Forest Fragmentation", "transformations": [{"chart_options": {"bins": [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 7000, 12000, 17000, 27000, 500000], "title": "Forest Fragment Distribution", "x_label": "Area (ha)", "y_label": "Cumulative Area (%)"}, "chart_type": "line", "data_structure": {"color": "#4BC0C0", "x_field": "keys", "y_field": "values"}, "name": "fragment_size_distribution"}, {"chart_options": {"label": "Effective Mesh Size (km\u00b2)", "max": 1000, "min": 0, "title": "Fragmentation"}, "chart_type": "gauge", "name": "effective_mesh_size"}]}, "forest_humidity": {"data_source": [{"name": "forest_cover", "type": "layer"}, {"name": "holdridge", "type": "shape"}], "description": "Distribution of forests by humidity level", "field_type": "JSON", "label": "Forest and Living Environments", "transformations": [{"chart_options": {"categories": ["Dry", "Humid", "Very Humid"], "title": "Forest and Living Environments", "x_label": "Category", "y_label": "Frequency (%)"}, "chart_type": "stacked_bar", "layer_params": {"forest_cover": [{"name": "area"}], "humidity": [{"name": "value"}]}, "name": "category_distribution"}]}, "land_use": {"data_source": [{"name": "ultramafic", "type": "shape"}, {"name": "holdridge", "type": "shape"}, {"name": "forest_cover", "type": "layer"}], "description": "Land use distribution", "field_type": "JSON", "label": "Land Use", "transformations": [{"chart_options": {"title": "Land Use", "x_label": "Category", "y_label": "Area (ha)"}, "chart_type": "bar", "name": "category_distribution"}]}, "num_families": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of families in the zone", "field_type": "INTEGER", "label": "Number of Families", "transformations": [{"chart_options": {"title": "Number of Families"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["family"]}]}, "num_occurrences": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of occurrences in the zone", "field_type": "INTEGER", "label": "Number of Occurrences", "source_field": "id_occurrence", "transformations": [{"chart_options": {"title": "Number of Occurrences"}, "chart_type": "text", "name": "count"}]}, "num_species": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of species in the zone", "field_type": "INTEGER", "label": "Number of Species", "transformations": [{"chart_options": {"title": "Number of Species"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["species", "infra"]}]}, "rainfall": {"data_source": {"name": "rainfall", "type": "layer"}, "description": "Average annual rainfall within the shape", "field_type": "TEXT", "label": "Average Rainfall", "transformations": [{"chart_options": {"title": "Average Rainfall"}, "chart_type": "text", "name": "mean"}, {"chart_options": {"title": "Rainfall Range"}, "chart_type": "text", "name": "range"}]}, "shape": {"data_source": {"name": "self", "type": "shape"}, "description": "Total area of the reference zone", "field_type": "TEXT", "label": "Shape Area", "transformations": [{"chart_options": {"title": "Total Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "shape_coordinates", "title": "Location"}, "chart_type": "map", "name": "coordinates"}]}}, "group_by": "shape", "source_location_field": "geo_pt", "source_table_name": "occurrences"};
    var currentShapeType = "mines";

    document.addEventListener('DOMContentLoaded', function () {
        loadShapeCharts(shape, mapping);
        loadShapeTypeList();
        initShapeMaps(mapping, shape);
        loadAllShapesMap(shape);
    });

    function loadShapeCharts(shape, mapping) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            if (field.field_type !== 'TEXT' && shape[field_key] !== null) {
                // Handle bins chart if present
                if (field.bins && field.bins.values && field.bins.values.length > 0) {
                    var binChartId = field_key + 'BinChart';
                    var binCtx = document.getElementById(binChartId);
                    if (binCtx) {
                        createBinChart(binCtx, field, shape);
                    }
                }

                // Handle transformations
                field.transformations.forEach(function(transformation) {
                    var transformationName = transformation.name ? transformation.name : '';
                    var valueKey = field_key + '_' + transformationName;

                    if (shape[valueKey] !== null) {
                        switch(transformation.chart_type) {
                            case 'pie':
                                var pieChartId = field_key + 'PieChart';
                                var pieCtx = document.getElementById(pieChartId);
                                if (pieCtx) {
                                    createPieChart(pieCtx, transformation, shape[valueKey]);
                                }
                                break;
                            case 'gauge':
                                var gaugeId = field_key + transformationName + 'Gauge';
                                var gaugeElement = document.getElementById(gaugeId);
                                if (gaugeElement) {
                                    createGauge({
                                        id: gaugeId,
                                        value: parseFloat(shape[valueKey]),
                                        min: 0,
                                        max: transformation.chart_options.max,
                                        title: transformation.chart_options.title,
                                        label: transformation.chart_options.label
                                    });
                                }
                                break;
                            case 'bar':
                                var barChartId = field_key + transformationName + 'BarChart';
                                var barCtx = document.getElementById(barChartId);
                                if (barCtx) {
                                    createBarChart(barCtx, field, transformation, shape[valueKey]);
                                }
                                break;
                            case 'stacked_bar':
                                if (field_key === 'elevation' && transformationName === 'elevation_distribution') {
                                    var stackedBarChartId = 'elevationDistributionChart';
                                    var stackedBarCtx = document.getElementById(stackedBarChartId);
                                    if (stackedBarCtx) {
                                        createElevationDistributionChart(stackedBarCtx, shape.elevation_elevation_distribution, transformation);
                                    }
                                }
                                break;
                            case 'line':
                                if (field_key === 'forest_fragmentation' && transformationName === 'fragment_size_distribution') {
                                    var lineChartId = 'forestFragmentationChart';
                                    var lineCtx = document.getElementById(lineChartId);
                                    if (lineCtx) {
                                        createForestFragmentationChart(lineCtx, shape.forest_fragmentation_fragment_size_distribution, transformation);
                                    }
                                }
                                break;
                        }
                    }
                });
            }
        });
    }

    function createBinChart(ctx, field, shape) {
        var binData = {
            labels: field.bins.values,
            datasets: [{
                label: field.label,
                data: field.bins.values.map(value => shape.frequencies[field.field_key][value] || 0),
                backgroundColor: field.bins.chart_options.color
            }]
        };

        new Chart(ctx, {
            type: field.bins.chart_type,
            data: binData,
            options: field.bins.chart_options
        });
    }

    function createPieChart(ctx, transformation, data) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['True', 'False'],
                datasets: [{
                    data: [data.true || 0, data.false || 0],
                    backgroundColor: ['#FF6384', '#36A2EB']
                }]
            },
            options: {
                title: {
                    display: true,
                    text: transformation.chart_options.title
                }
            }
        });
    }

    function createBarChart(ctx, field, transformation, data) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: field.label,
                    data: Object.values(data),
                    backgroundColor: getColor(0).background,
                    borderColor: getColor(0).border,
                    borderWidth: 1
                }]
            },
            options: transformation.chart_options
        });
    }

    function createElevationDistributionChart(ctx, elevationData, chartConfig) {
        const altitudes = elevationData.altitudes.reverse();
        const forestData = elevationData.forest.reverse();
        const nonForestData = elevationData.non_forest.reverse();

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: altitudes,
                datasets: [
                    {
                        label: 'Forest',
                        data: forestData,
                        backgroundColor: '#4CAF50',
                        stack: 'Stack 0',
                    },
                    {
                        label: 'Non-Forest',
                        data: nonForestData,
                        backgroundColor: '#FFF59D',
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Area (ha)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString(); // Format les grands nombres
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Elevation (m)'
                        },
                        reverse: false
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 0,
                        bottom: 10
                    }
                }
            }
        });
    }

    function createForestFragmentationChart(ctx, fragmentationData, chartConfig) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(fragmentationData),
                datasets: [{
                    label: 'Cumulative Area (%)',
                    data: Object.values(fragmentationData),
                    borderColor: '#4BC0C0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.x_label
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.y_label
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartConfig.chart_options.title
                    }
                }
            }
        });
    }

    function createGauge(options) {
        new JustGage({
            id: options.id,
            value: options.value || 0,
            min: options.min || 0,
            max: options.max,
            title: options.title,
            label: options.label,
            pointer: true,
            pointerOptions: {
                toplength: 10,
                bottomlength: 10,
                bottomwidth: 2,
                color: '#8e8e93',
                stroke: '#ffffff',
                stroke_width: 3,
                stroke_linecap: 'round'
            },
            gaugeWidthScale: 0.6,
            counter: true,
            donut: true,
            relativeGaugeSize: true,
            donutStartAngle: 270,
            hideInnerShadow: true,
            customSectors: [{
                color: "#ff0000",
                lo: 0,
                hi: options.max * 0.33
            }, {
                color: "#ffff00",
                lo: options.max * 0.33,
                hi: options.max * 0.66
            }, {
                color: "#00ff00",
                lo: options.max * 0.66,
                hi: options.max
            }],
            humanFriendly: true,
            formatNumber: true,
            textRenderer: function (val) {
                return parseFloat(val).toFixed(2);
            }
        });
    }

    // Function to get a color based on the index
    function getColor(index) {
        var colors = [
            {background: 'rgba(54, 162, 235, 0.6)', border: 'rgba(54, 162, 235, 1)'},
            {background: 'rgba(75, 192, 192, 0.6)', border: 'rgba(75, 192, 192, 1)'},
            {background: 'rgba(255, 99, 132, 0.6)', border: 'rgba(255, 99, 132, 1)'}
        ];
        return colors[index % colors.length];
    }

// Rest of the code (loadShapeTypeList, initShapeMaps, loadAllShapesMap) remains the same...

    let maps = {};  // Object to keep track of initialized maps

    function initMap(field_key, geometry) {
        const mapId = field_key + 'Map';
        const mapLoaderId = field_key + 'MapLoader';

        // Check if the map already exists
        if (maps[mapId]) {
            return; // Map is already initialized, so do nothing
        }

        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        map.on('load', function () {
            document.getElementById(mapLoaderId).style.display = 'none';
        });

        if (geometry) {
            const geoJsonLayer = L.geoJSON(geometry, {
                style: function() {
                    return {
                        color: '#228b22', // Border color
                        weight: 2,       // Border width
                        fillColor: '#228b22cc', // Fill color with opacity
                        fillOpacity: 0.8 // Fill opacity
                    };
                }
            }).addTo(map);
            map.fitBounds(geoJsonLayer.getBounds());
        } else {
            console.warn("No geographic coordinates found.");
            // Set default view if no geometry is found
            map.setView([-21.291237, 165.516418], 10);
        }

        // Store the map instance in the maps object
        maps[mapId] = map;
    }

    function initShapeMaps(mapping, shape) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            field.transformations.forEach(function(transformation) {
                if (transformation.chart_type === 'map') {
                    var coordinatesField = transformation.chart_options.coordinates_field;
                    var geometry = shape[coordinatesField];

                    // Check if geometry is a string, if so, parse it as JSON
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.error("Invalid JSON for field", coordinatesField, ":", geometry);
                            return; // Skip this field if JSON is invalid
                        }
                    }

                    // Initialize the map with the parsed geometry
                    initMap(field_key, geometry);
                }
            });
        });
    }

    function loadAllShapesMap(currentShape) {
        const mapId = 'allShapesMap';
        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        var group = L.featureGroup(); // Create a group to hold all the layers

        shapeTypes.forEach(function(shapeTypeItem) {
            if (shapeTypeItem.type === currentShape.type) {
                shapeTypeItem.shapes.forEach(function(shapeItem) {
                    var geometry = shapeItem.geometry;
                    // No need to parse geometry if it's already GeoJSON
                    var layer = L.geoJSON(geometry, {
                        style: function() {
                            return {
                                color: '#228b22', // Border color
                                weight: 2,       // Border width
                                fillColor: '#228b22cc', // Fill color with opacity
                                fillOpacity: 0.8 // Fill opacity
                            };
                        }
                    }).addTo(map);
                    group.addLayer(layer); // Add each layer to the group

                    // Highlight current shape
                    if (shapeItem.id === currentShape.id) {
                        layer.setStyle({color: 'red', weight: 3, fillOpacity: 0.4});
                        layer.bringToFront(); // Ensure the highlighted shape is on top
                    } else {
                        layer.setStyle({fillOpacity: 0.2}); // Reduce opacity for other shapes
                    }

                    // Show tooltip on hover with additional content
                    var tooltipContent = "<strong>" + shapeItem.name + "</strong><br>";

                    


                    layer.bindTooltip(tooltipContent, {
                        permanent: false,
                        direction: 'right',
                        offset: L.point(10, 0),
                        opacity: 0.9,
                        className: 'custom-tooltip'
                    });


                    layer.on('mousemove', function(e) {
                        var tooltip = e.target.getTooltip();
                        tooltip.setLatLng(e.latlng);
                    });

                    layer.on('click', function() {
                        window.location.href = '../shape/' + shapeItem.id + '.html';
                    });
                });
            }
        });

        map.fitBounds(group.getBounds()); // Adjust the view to fit the bounds of the group

        map.attributionControl.setPrefix(false);
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        maps['allShapesMap'] = map;
    }

    function loadShapeTypeList() {
            var shapeTypeListElement = document.getElementById("shape-type-list");
            shapeTypes.forEach(function (shapeTypeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "javascript:void(0)";
                a.textContent = shapeTypeItem.type;
                a.className = "shape-type-link";
                if (shapeTypeItem.type === currentShapeType) {
                    a.classList.add("active");
                }
                a.onclick = function () {
                    if (shapeTypeItem.shapes.length > 0) {
                        // Redirect to the first shape of the selected type
                        window.location.href = "../shape/" + shapeTypeItem.shapes[0].id + ".html";
                    }
                    loadShapeList(shapeTypeItem.shapes);
                };
                li.appendChild(a);
                shapeTypeListElement.appendChild(li);
            });
        }

        function loadShapeList(shapes) {
            var shapeListElement = document.getElementById("shape-list");
            shapeListElement.innerHTML = ''; // Clear the previous list
            shapes.forEach(function (shapeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "../shape/" + shapeItem.id + ".html";
                a.textContent = shapeItem.name;
                a.className = "shape-link";
                if (shapeItem.id === shape.id) {
                    a.classList.add("active");
                }
                li.appendChild(a);
                shapeListElement.appendChild(li);
            });
        }

</script>

</body>
</html>