<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Niamoto - Zone tampon d'aire de gestion durable des ressources</title>
    <link rel="stylesheet" href="../js/vendor/tailwindcss/2.2.19_dist_tailwind.css">
    <link rel="stylesheet" href="../js/vendor/leaflet/1.9.4_leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
<script src="../js/shape_list.js"></script>

<style>
    #shape-type-list li, #shape-list li {
        list-style: none;
        text-transform: capitalize;
    }

    .shape-type-link, .shape-link {
        display: block;
        padding: 10px;
        border-radius: 5px;
        text-decoration: none;
    }

    .shape-type-link:hover, .shape-link:hover {
        background-color: #f0f0f0;
    }

    .shape-type-link.active, .shape-link.active {
        background-color: #3498db;
        color: #fff;
    }

    #shapeMap, #allShapesMap {
        position: relative;
        height: 300px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #allShapesMap {
        height: 400px;
    }

    .chart-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .chart-container > div {
        flex: 1 1 calc(33.333% - 10px);
        margin: 5px;
    }
    .custom-tooltip {
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    font-size: 12px;
    max-width: 300px;
    word-wrap: break-word;
}
</style>

    <style>
        .gauge {
            height: 349px;
        }

        ul {
            list-style-type: none;
        }

        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bg p-4 fixed w-full top-0 shadow-md z-50 custom-nav">
    <div class="container mx-auto flex flex-wrap items-center justify-between">
        <div class="flex items-center flex-shrink-0 text-white mr-6">
            <a id="home-link" class="inline-flex items-center py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                <span class="site-title">Niamoto</span>
            </a>
        </div>

        <div class="block lg:hidden">
            <button id="nav-toggle"
                class="flex items-center px-3 py-2 border rounded text-teal-200 border-teal-400 hover:text-white hover:border-white">
                <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <title>Menu</title>
                    <path d="M0 3h20v2H0zm0 6h20v2H0zm0 6h20v2H0z" />
                </svg>
            </button>
        </div>
        <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block pt-6 lg:pt-0" id="nav-content">
            <ul class="list-reset lg:flex justify-end flex-1 items-center">
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                        <i class="fas fa-home menu-icon"></i>Accueil
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#introduction">Introduction</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#project">Projet</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#objective">Objectifs</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#context">Contexte</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#flora">Flore</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="methodology.html">
                        <i class="fas fa-flask menu-icon"></i>Méthodologie
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#methodes">Nos méthodes</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#faq">FAQ</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="trees.html">
                        <i class="fas fa-leaf menu-icon"></i>Arbres
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#learnTaxon">Étudier les
                arbres</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#taxon">Les arbres de
                Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="plots.html">
                        <i class="fas fa-map-marked-alt menu-icon"></i>Peuplements
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#learnPlot">Étudier les
                            peuplements forestiers</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#plot">Les
                peuplements forestiers de Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="forests.html">
                        <i class="fas fa-tree menu-icon"></i>Forêt
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#learnForest">Étudier les
                forêts</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPN">La forêt de la
                province Nord</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPS">La forêt de la
                province Sud</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="resources.html">
                        <i class="fas fa-book menu-icon"></i>Ressources
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#equipe">L'équipe</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#article">Articles</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#academic">Académique</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#media-production">Médias</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
  document.getElementById('nav-toggle').onclick = function () {
    document.getElementById('nav-content').classList.toggle('hidden');
  };

  // Function to adjust the navigation links based on page depth
  function adjustNavLinks(depth) {
    document.querySelectorAll('a[data-link]').forEach(link => {
      link.href = depth + link.getAttribute('data-link');
    });
  }

  // Adjust the navigation links based on the depth
  adjustNavLinks("../");
</script>

<style>
    .site-title {
        font-family: 'Arial Black', sans-serif; /* Custom font for a bold effect */
        font-size: 2rem; /* Increased font size */
        text-transform: uppercase; /* Uppercase letters for visibility */
        letter-spacing: 2px; /* Spacing between letters */
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7); /* Text shadow for better visibility */
        transition: color 0.3s; /* Smooth transition for hover effect */
    }

    .site-title:hover {
        color: #ffdd57; /* Change color on hover */
    }

    .text-contour {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .nav-bg {
        background-color: rgba(34, 139, 34, 0.8); /* Fond vert semi-transparent */
        transition: background-color 0.3s;
    }

    .nav-bg:hover {
        background-color: rgba(34, 139, 34, 1); /* Fond vert opaque au survol */
    }

    .group:hover .group-hover\:block {
        display: block;
    }

    .custom-nav {
        z-index: 500;
    }

    .custom-dropdown {
        z-index: 500;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2); /* Fond blanc transparent au survol */
        border-radius: 4px;
    }

    .menu-icon {
        margin-right: 8px;
    }
</style>
    <div class="flex">
        
<aside class="w-1/4 p-4 mt-28">
    <h2 class="font-semibold text-lg mb-4">Shape Types</h2>
    <ul id="shape-type-list" class="list-disc pl-5">
        <!-- The list of shape types will be generated by JavaScript -->
    </ul>
</aside>

        <div class="w-full">
            
<div id="allShapesMap" class="mt-28"></div>

<div class="rounded overflow-hidden shadow-lg mb-2 mt-8">
    <div class="px-6 py-4">
        <div class="font-bold text-4xl mb-2">Zone tampon d'aire de gestion durable des ressources</div>
    </div>
</div>

<div class="chart-container">
    <!-- Section for general information -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">General Information</h2>
            
                
                    
                        
                        
                            <p>Shape Area (Total Area): 3090.597036989674</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Forest Area (Forest Area): 1584.4129811334494</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Number of Families (Number of Families): 41</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Species (Number of Species): 94</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Occurrences (Number of Occurrences): 172</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Average Rainfall (Average Rainfall): 2608.0</p>
                        
                    
                
                    
                        
                        
                            <p>Average Rainfall (Rainfall Range): {"min": 2280.0, "max": 3080.0}</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Altitude (Median Altitude): 404.5</p>
                        
                    
                
                    
                        
                        
                            <p>Altitude (Maximum Altitude): 1298.0</p>
                        
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        </div>
    </div>

    <!-- Section for shape map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Shape Map</h2>
            <div id="shapeMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="shapeMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Section for forest map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Forest Map</h2>
            <div id="forestMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="forestMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div class="flex flex-wrap -mx-2">
    

    

    
    
        
    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
    
        
            
            

            
            
                
            
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Elevation Distribution</h2>
        
    
    
        <canvas id="elevationDistributionChart"></canvas>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Forest Fragment Distribution</h2>
        
    
    
        <canvas id="forestFragmentationChart"></canvas>
    
    
                        </div>
                    </div>
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Fragmentation</h2>
        
    
    
        <div class="gauge" id="forest_fragmentationeffective_mesh_sizeGauge"></div>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
</div>

        </div>
    </div>
    <footer class="bg-green-700 text-white p-4 mt-8">
        <div class="container mx-auto">
            <div class="flex justify-center mb-4">
                <div class="bg-white p-2 rounded-lg shadow-md flex justify-center">
                    <figure class="mx-2"><img class="img-fluid" src="../files/ps_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/pn_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/amap_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/herbarium_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/iac_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/ird_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/cirad_100.png"></figure>
                </div>
            </div>
            <div class="text-center">
                <p>Niamoto - Portail de la forêt de Nouvelle-Calédonie</p>
                <a class="inline-block py-2 px-4 text-white no-underline" href="https://github.com/niamoto/niamoto" target="_blank">
                    <span class="fab fa-github fa-lg" aria-hidden="true"></span> Github
                </a>
            </div>
        </div>
    </footer>
    <script src="../js/vendor/chart/4.4.2_chart.js"></script>
    <script src="../js/vendor/d3/7.8.5_d3.js"></script>
    <script src="../js/vendor/jquery/3.6.0_jquery.js"></script>
    <script src="../js/vendor/raphael/2.3.0_raphael.js"></script>
    <script src="../js/vendor/justgage/1.6.1_justgage.js"></script>
    <script src="../js/vendor/leaflet/1.9.4_leaflet.js"></script>
    
<script>
    var shape = {"elevation_elevation_distribution": {"altitudes": [0.0, 100.0, 200.0, 300.0, 400.0, 500.0, 600.0, 700.0, 800.0, 900.0, 1000.0, 1100.0, 1200.0], "forest": [111.12809964453108, 106.68297565874983, 82.234793736953, 50.007644840038985, 87.79119871917955, 153.35677750945288, 216.6997943068356, 215.58851331039028, 218.92235629972623, 192.25161238503875, 104.4604136658592, 45.56252085425774, 17.780495943124972], "non_forest": [537.8600022795304, 234.48029024996058, 193.36289338148407, 204.47570334593718, 156.6906204987888, 106.68297565874983, 24.448181921796838, 2.2225619928906215, 4.445123985781243, 1.1112809964453108, 1.1112809964453108, 0.0, 0.0]}, "elevation_max": 1298.0, "elevation_median": 404.5, "forest_area": "1584.4129811334494", "forest_coordinates": "{\"type\": \"MultiPolygon\", \"coordinates\": [[[[164.6142580272747, -20.44670849056756], [164.61707198245662, -20.442738675824387], [164.61604514907302, -20.444849564251665], [164.61706400703753, -20.4472742670857], [164.6253332408776, -20.446015353608708], [164.6245480215259, -20.443312044518308], [164.6270215874777, -20.44476765048697], [164.6317121427848, -20.442220338224633], [164.6361556910564, -20.441287208192854], [164.63763500181554, -20.43991112905074], [164.6364995243107, -20.438417984155258], [164.63851796609939, -20.438252198478477], [164.63853283218305, -20.435882895707376], [164.64419098241854, -20.43218384624655], [164.64434978019474, -20.43097647451285], [164.64539035371232, -20.42936904736806], [164.64366952149214, -20.434304846343746], [164.63972307882847, -20.436617361930697], [164.63973113792812, -20.43963678255191], [164.63852132251824, -20.438920340182136], [164.63672982505292, -20.44655949623448], [164.63465836312238, -20.444907169169426], [164.63114769817608, -20.44882729903096], [164.63213093482156, -20.446251817581956], [164.63033104863652, -20.446616184325947], [164.6326926620112, -20.443043427623003], [164.62995825484143, -20.44449330646819], [164.62840947245544, -20.448982834762955], [164.63100071131842, -20.449601500360604], [164.6308888509718, -20.45324654240834], [164.6404587498526, -20.451699660558056], [164.63969739134475, -20.453583156868703], [164.64487974073873, -20.452980377661344], [164.64646618137957, -20.450363590474527], [164.65018075182056, -20.449064105412262], [164.65065831038348, -20.44742414911117], [164.6538197625615, -20.445207446399063], [164.6487574371351, -20.44556867278029], [164.64665413985773, -20.448250685547546], [164.6462547700786, -20.44616029605253], [164.6521119165846, -20.44353295365869], [164.65442576393153, -20.44509579205623], [164.65569708979794, -20.43976334674783], [164.6582214114221, -20.440458794112967], [164.65532486724345, -20.44470402764904], [164.6509565000021, -20.447611187312713], [164.65087451915537, -20.449210113115424], [164.64663691381472, -20.450842998434116], [164.64548982719523, -20.454499634400786], [164.64253251576585, -20.453635496145957], [164.6392851020065, -20.45652328312798], [164.63997338492845, -20.45886708689], [164.64535093903683, -20.4578420283877], [164.64764946049024, -20.458571088566863], [164.6418162525945, -20.460094694416604], [164.6394964124368, -20.4626122279588], [164.64412862956186, -20.462547595292158], [164.64705657956335, -20.46088247598137], [164.64233989847506, -20.46111336644462], [164.64493284303884, -20.459425202804493], [164.64648034868023, -20.460051915473336], [164.65069844086324, -20.456540439492453], [164.6569660568339, -20.4556236130884], [164.65928103829964, -20.45056140453397], [164.6563275978878, -20.44914565654948], [164.65489449627657, -20.452285336102076], [164.6538140748597, -20.451348125883474], [164.6512360095076, -20.452740168308882], [164.6506775291539, -20.4547647275252], [164.64955326488206, -20.455563753046935], [164.6473699343243, -20.45548964234382], [164.65046647964735, -20.454350077119855], [164.64722190743538, -20.45421348940373], [164.64795511534743, -20.45330605738738], [164.65504279636238, -20.450855680241048], [164.65598373794685, -20.448622762239264], [164.65910505230298, -20.449697926221678], [164.6615590520052, -20.44809312579036], [164.65831581221104, -20.455192101038936], [164.65359607993608, -20.459705272294496], [164.65269527793637, -20.465251416609966], [164.65194752301872, -20.46581933513365], [164.65262610824587, -20.470633682897546], [164.6524220866083, -20.46634263437792], [164.65713580028583, -20.463319622654204], [164.6626882642296, -20.455303912621567], [164.67116250990526, -20.454021686416134], [164.67219906490465, -20.456501280249533], [164.6695411585512, -20.46044861139378], [164.67409241210478, -20.458410847233914], [164.6741566147757, -20.46041179266874], [164.6726865486326, -20.463490863306642], [164.6731406443126, -20.464178479620855], [164.67744259111458, -20.45964758091181], [164.67426965697544, -20.466651895919256], [164.6747981128, -20.463102707299996], [164.6711450643, -20.4666892108], [164.6707527636, -20.468639361000005], [164.6723164435, -20.4669998356], [164.6719441544, -20.470284092499995], [164.6693207751, -20.472739253899995], [164.66937053836423, -20.477466797365942], [164.66724000163856, -20.48216999942031], [164.66143570164076, -20.482371854496623], [164.6517739265996, -20.479034932565725], [164.64842025668568, -20.479741804473107], [164.64330048817726, -20.47845176390841], [164.63510466301022, -20.47277336249001], [164.62779961512604, -20.472522721030586], [164.61659446064465, -20.465446519639357], [164.6078204837361, -20.46535436222133], [164.60270999985238, -20.462859998919473], [164.6142580272747, -20.44670849056756]], [[164.6493078362923, -20.462303971858137], [164.64933790327638, -20.46246899749965], [164.64878032299004, -20.463357248747354], [164.65020751725189, -20.461574199802747], [164.6493078362923, -20.462303971858137]], [[164.62632080221073, -20.44649298837666], [164.62286304562033, -20.447719179451564], [164.62217519829787, -20.44893699299577], [164.626043682287, -20.447804940466085], [164.62927619918563, -20.444283416419328], [164.62632080221073, -20.44649298837666]], [[164.63608874332903, -20.442508211122423], [164.63409089075327, -20.442359533721444], [164.63195865381982, -20.445262386618506], [164.63560653959445, -20.444029238577293], [164.63608874332903, -20.442508211122423]], [[164.63817750972004, -20.45422657763396], [164.63736118971389, -20.455099909519006], [164.63947168954556, -20.454021265268214], [164.63903792193705, -20.454020365744608], [164.63817750972004, -20.45422657763396]], [[164.63710160812326, -20.44221085632046], [164.6369436383847, -20.441690485416995], [164.6363675134559, -20.442415287746815], [164.63688788435934, -20.442461749434628], [164.63710160812326, -20.44221085632046]], [[164.64100167904198, -20.460407857509768], [164.64293674461106, -20.459522464814597], [164.63945053923996, -20.459823685268628], [164.63861007329558, -20.46124924586212], [164.64100167904198, -20.460407857509768]], [[164.64406151318585, -20.46349827407625], [164.64485380595278, -20.46314844698063], [164.64512843997076, -20.462862112100012], [164.64386398934082, -20.463347249512513], [164.64406151318585, -20.46349827407625]], [[164.64566251711332, -20.462275065239112], [164.64644517036226, -20.462807415055828], [164.64686577555494, -20.461918893291415], [164.64618858555122, -20.461860137723157], [164.64566251711332, -20.462275065239112]], [[164.6460173596424, -20.466837426691892], [164.64566388187066, -20.46831421806032], [164.6481872292364, -20.46646886667544], [164.64601933254679, -20.46597674432777], [164.6460173596424, -20.466837426691892]], [[164.65139863336705, -20.462909769396624], [164.6509396327123, -20.46763634111912], [164.6496937777472, -20.469979205834072], [164.6508446234759, -20.469264282341882], [164.6517581117817, -20.46580185069271], [164.6524060093478, -20.465358458869197], [164.65291841003474, -20.460862391865415], [164.65172322009295, -20.4610249675312], [164.6547198801402, -20.45844457004075], [164.65438126939048, -20.456712486986355], [164.65142476332463, -20.458384928154924], [164.65139863336705, -20.462909769396624]], [[164.64747083872103, -20.463569770686675], [164.65080400981034, -20.460298712465317], [164.6518080851238, -20.457137698886672], [164.64855358734852, -20.459318733868653], [164.64747083872103, -20.463569770686675]], [[164.6551496909, -20.471472966299995], [164.6552053615, -20.470099757799996], [164.6550012359, -20.4698770753], [164.6550383497, -20.4725121511], [164.6551496909, -20.471472966299995]], [[164.65867505155023, -20.464999250566493], [164.65722748786823, -20.46563023986379], [164.65943179472276, -20.463484304337637], [164.65898506308102, -20.461901319613716], [164.6541476198, -20.466796634599998], [164.65716253308764, -20.469276986831943], [164.6576636128237, -20.472654635423314], [164.6608092800558, -20.46748609073817], [164.66030400972699, -20.464078152851144], [164.6591204557601, -20.466706633370926], [164.65949095313246, -20.463995550833033], [164.65867505155023, -20.464999250566493]], [[164.66015973224975, -20.471448332354978], [164.66008549821478, -20.470937973364517], [164.65980712058362, -20.470891577092655], [164.65954730146123, -20.47168031371427], [164.66015973224975, -20.471448332354978]], [[164.66243314957086, -20.47014923674291], [164.66758976766315, -20.463778371801173], [164.66640034845526, -20.464029264915336], [164.66621450170402, -20.46225442844106], [164.6650994211966, -20.464837698283205], [164.66400292536434, -20.465599669963268], [164.66516446755955, -20.46289559973281], [164.66392858666384, -20.46345313998652], [164.66640034845526, -20.46100925520779], [164.664328157179, -20.45990346703795], [164.66377990926287, -20.46210575104007], [164.66188427240027, -20.461892027276143], [164.6645232962678, -20.45881626354323], [164.66478812788833, -20.45579625383567], [164.66101543883826, -20.45968045093646], [164.66044319297237, -20.46261208933343], [164.66223401739583, -20.466017439403046], [164.6609627659485, -20.465641124205632], [164.6606236949684, -20.47181950252984], [164.658693610059, -20.474139316122816], [164.6590074541491, -20.476827095824607], [164.66164441294927, -20.479205789009892], [164.66144026935308, -20.474185712394693], [164.65938955413688, -20.47574462712917], [164.65977928282052, -20.47393517252665], [164.66249810435147, -20.472747427967047], [164.66243314957086, -20.47014923674291]], [[164.6664731902, -20.466199761], [164.6641689302, -20.4688921466], [164.6642889862, -20.469681341900007], [164.6682245792, -20.465758423000008], [164.66848183206906, -20.463248708560155], [164.6664731902, -20.466199761]], [[164.6657063716, -20.4688592477], [164.6654741187, -20.4706734168], [164.6683657893, -20.465861237300004], [164.6672776018, -20.4667865143], [164.6657063716, -20.4688592477]], [[164.66713444312262, -20.460981378195104], [164.66715302779775, -20.460237991190166], [164.66677204195773, -20.460172944827235], [164.6667534572826, -20.4609813781951], [164.66713444312262, -20.460981378195104]], [[164.6682309389549, -20.461492456761], [164.66824023129246, -20.460776946768746], [164.66863980180761, -20.460117190801867], [164.667719860389, -20.460702608068253], [164.6682309389549, -20.461492456761]], [[164.66577776183863, -20.460014975088683], [164.66902078764767, -20.45686487265527], [164.6712881180127, -20.456632564216225], [164.67094065096174, -20.455692378776533], [164.665006497821, -20.45794278381243], [164.66577776183863, -20.460014975088683]], [[164.6679363718, -20.4688348317], [164.6667691158, -20.470137974299995], [164.6668457145, -20.473437422399996], [164.6699850091, -20.471765070500005], [164.6698224902, -20.465904912599992], [164.6679363718, -20.4688348317]], [[164.66928064220002, -20.463049267100008], [164.6693789329, -20.463350694900008], [164.6686358418, -20.465622931599995], [164.6704809933, -20.464034164999998], [164.66928064220002, -20.463049267100008]], [[164.67176977040003, -20.462810121500002], [164.6706754856, -20.465619634300005], [164.67365621100004, -20.459657813099998], [164.6717281321, -20.460916527999995], [164.67176977040003, -20.462810121500002]], [[164.67021020685556, -20.458128630563664], [164.67013586815506, -20.4570507194065], [164.6674132132495, -20.459912759375502], [164.66909512634814, -20.45954106587303], [164.67021020685556, -20.458128630563664]], [[164.67009405263605, -20.455619699421998], [164.67067946990244, -20.4553037599449], [164.67062371587707, -20.45494135877999], [164.66952722004478, -20.4550621591683], [164.67009405263605, -20.455619699421998]]], [[[164.63336546548902, -20.450796882938025], [164.6326489177962, -20.451046328268845], [164.63249778162913, -20.450659046165818], [164.63395118235863, -20.450490084605427], [164.63336546548902, -20.450796882938025]]], [[[164.63443135429023, -20.45091003455224], [164.6353816330835, -20.45058597542721], [164.63549374838732, -20.449387991547653], [164.63562585478576, -20.45075049801357], [164.63345453983445, -20.451557406142964], [164.63443135429023, -20.45091003455224]]], [[[164.62569391682413, -20.430715629417215], [164.62725458935424, -20.430375849479503], [164.62622586936448, -20.429913962055785], [164.62738458875455, -20.428290581226918], [164.62782647135094, -20.430049272426476], [164.6287385373609, -20.428300440736788], [164.63398612915475, -20.428104451431658], [164.63511273277524, -20.428848454684005], [164.63297004484235, -20.428977584822775], [164.6365809875275, -20.43059549725041], [164.63619865130775, -20.432242373407917], [164.63823344465806, -20.434329430196488], [164.63616314335994, -20.435743140402952], [164.6364266698129, -20.433895653203262], [164.63467233070898, -20.433493314932047], [164.63548462967293, -20.436468011026253], [164.63445889553526, -20.435237277190115], [164.6314704515608, -20.43888402831928], [164.63051747845472, -20.43726477509051], [164.6315631899025, -20.439943484570126], [164.62978864649392, -20.442573057602583], [164.62991068786684, -20.439694974776867], [164.6269081575859, -20.439915539018592], [164.6285252407242, -20.437360365084224], [164.62706222811124, -20.4373702868198], [164.63009467838617, -20.435873083971135], [164.63109777831224, -20.43268631762518], [164.62869364732055, -20.429693136723852], [164.62805996593664, -20.43373619301426], [164.626157065242, -20.434192083909604], [164.62715701497382, -20.431612558550935], [164.62493114436538, -20.431727888499218], [164.62569391682413, -20.430715629417215]], [[164.62990004651286, -20.428885644256948], [164.63011377027678, -20.430167986840466], [164.63126602013443, -20.4296011542492], [164.63094078831978, -20.42882989023158], [164.62990004651286, -20.428885644256948]], [[164.63117309675883, -20.433299504598775], [164.6309872500076, -20.43371765978905], [164.63142398987299, -20.4345539701696], [164.63210233051498, -20.433169411872907], [164.63117309675883, -20.433299504598775]], [[164.63125672779688, -20.431329529035693], [164.6320279918145, -20.431348113710808], [164.6319815301267, -20.429991432426803], [164.6308608420109, -20.430913126223036], [164.63125672779688, -20.431329529035693]], [[164.6334868888117, -20.43463760120766], [164.63383070530148, -20.435538957951135], [164.63384928997658, -20.433578274725622], [164.63354725028776, -20.433604177116578], [164.6334868888117, -20.43463760120766]]], [[[164.62212908418533, -20.43565361099647], [164.62283370138604, -20.434666433199048], [164.62290800835427, -20.435404180388304], [164.62212908418533, -20.43565361099647]]], [[[164.62460341410272, -20.433298446944487], [164.62539878021943, -20.435686884630996], [164.6239691345229, -20.43718212758246], [164.62267484746087, -20.436231976236943], [164.62460341410272, -20.433298446944487]]], [[[164.63528220084817, -20.426751792196626], [164.63572637814272, -20.42593544535388], [164.6374632127542, -20.426137568040875], [164.6346971400901, -20.427460724640245], [164.63528220084817, -20.426751792196626]]], [[[164.6707638642, -20.474140610099997], [164.67140920613912, -20.47296639784152], [164.6702921548712, -20.475432310658135], [164.6702294564, -20.474907043200005], [164.6707638642, -20.474140610099997]]], [[[164.6727789437876, -20.46994267483096], [164.6726764168, -20.469518026099998], [164.67306790995193, -20.469304776295175], [164.6727789437876, -20.46994267483096]]], [[[164.6733113413, -20.4679914992], [164.67373014630766, -20.46784287641277], [164.67312899321564, -20.469169933779735], [164.6731124312, -20.468478848500002], [164.6733113413, -20.4679914992]]], [[[164.64161677820067, -20.449341139828864], [164.64116782956572, -20.45084745339971], [164.64287955935484, -20.449721425824034], [164.64459978089556, -20.449534561091376], [164.6456370552787, -20.44847918968219], [164.64628303360922, -20.448752782235147], [164.64076003117884, -20.45146661075045], [164.64161677820067, -20.449341139828864]]], [[[164.63961676147073, -20.44555650132075], [164.6409228725239, -20.443824922932897], [164.63956198407573, -20.444740205253066], [164.6393302812291, -20.443039977572987], [164.64254771957002, -20.44072623895891], [164.64474299023405, -20.440166327644818], [164.6465918873789, -20.436325136479145], [164.64188704329456, -20.440761002645992], [164.6417014932984, -20.439386101575764], [164.64695106227273, -20.435204109122242], [164.6472306943377, -20.432871326617782], [164.64898632759463, -20.43153416542083], [164.64636976962973, -20.437611774231424], [164.64639515281772, -20.442817579261828], [164.64550981673665, -20.444166463530802], [164.64595642170158, -20.445135448487825], [164.64489011205754, -20.445857252912482], [164.64582682898856, -20.43923611592982], [164.64289015058696, -20.44583023367692], [164.6446000603215, -20.440372126014616], [164.64142673841747, -20.442931401789135], [164.64160978176793, -20.445893822414455], [164.63961676147073, -20.44555650132075]]], [[[164.6399857294511, -20.431203749463048], [164.6416364503542, -20.429299330948126], [164.64291835377446, -20.42927136602999], [164.6416341181645, -20.43147478923358], [164.63924834338565, -20.43198439058573], [164.6399857294511, -20.431203749463048]]]]}", "forest_cover_percentage": null, "forest_fragmentation_effective_mesh_size": 15.069913591654235, "forest_fragmentation_fragment_size_distribution": {"10": 0.7206066096420263, "100": 2.4905582181490358, "1000": 2.4905582181490358, "1100": 2.4905582181490358, "1200": 2.4905582181490358, "12000": 100.0, "125": 2.4905582181490358, "1300": 2.4905582181490358, "1400": 2.4905582181490358, "150": 2.4905582181490358, "1500": 2.4905582181490358, "1600": 100.0, "1700": 100.0, "17000": 100.0, "175": 2.4905582181490358, "1800": 100.0, "1900": 100.0, "20": 0.7206066096420263, "200": 2.4905582181490358, "2000": 100.0, "225": 2.4905582181490358, "250": 2.4905582181490358, "27000": 100.0, "275": 2.4905582181490358, "30": 2.4905582181490358, "300": 2.4905582181490358, "325": 2.4905582181490358, "350": 2.4905582181490358, "375": 2.4905582181490358, "40": 2.4905582181490358, "400": 2.4905582181490358, "425": 2.4905582181490358, "450": 2.4905582181490358, "475": 2.4905582181490358, "50": 2.4905582181490358, "500": 2.4905582181490358, "500000": 100.0, "60": 2.4905582181490358, "600": 2.4905582181490358, "70": 2.4905582181490358, "700": 2.4905582181490358, "7000": 100.0, "80": 2.4905582181490358, "800": 2.4905582181490358, "90": 2.4905582181490358, "900": 2.4905582181490358}, "forest_humidity_category_distribution": null, "frequencies": {}, "id": 50, "land_use_category_distribution": null, "name": "Zone tampon d\u0027aire de gestion durable des ressources", "num_families_unique_taxonomic_count": 41, "num_occurrences_count": 172, "num_species_unique_taxonomic_count": 94, "rainfall_mean": "2608.0", "rainfall_range": "{\"min\": 2280.0, \"max\": 3080.0}", "shape_area": "3090.597036989674", "shape_coordinates": "{\"type\": \"FeatureCollection\", \"features\": [{\"id\": \"0\", \"type\": \"Feature\", \"properties\": {}, \"geometry\": {\"type\": \"Polygon\", \"coordinates\": [[[164.63666282093857, -20.423272186217464], [164.64791471542065, -20.424572463574687], [164.6498847518883, -20.428892812393713], [164.65605465030157, -20.435190881328886], [164.66060826196698, -20.436890138476183], [164.66567100554315, -20.441303476176977], [164.67070376853346, -20.450555978420507], [164.6794541518107, -20.455207020801087], [164.66724000163856, -20.48216999942031], [164.66143570164076, -20.482371854496623], [164.65375935208837, -20.4796630950491], [164.64330048817726, -20.47845176390841], [164.63510466301022, -20.47277336249001], [164.62779961512604, -20.472522721030586], [164.61885515808305, -20.466309511358457], [164.6078204837361, -20.46535436222133], [164.60270999985238, -20.462859998919473], [164.63255018330398, -20.42105351655614], [164.63666282093857, -20.423272186217464]]]}, \"bbox\": [164.60270999985238, -20.482371854496623, 164.6794541518107, -20.42105351655614]}], \"bbox\": [164.60270999985238, -20.482371854496623, 164.6794541518107, -20.42105351655614]}", "shape_id": 50, "type": "protected_areas"};
    var mapping = {"fields": {"elevation": {"data_source": {"name": "elevation", "type": "layer"}, "description": "Altitude metrics within the shape", "field_type": "JSON", "label": "Altitude", "transformations": [{"chart_options": {"title": "Median Altitude"}, "chart_type": "text", "name": "median"}, {"chart_options": {"title": "Maximum Altitude"}, "chart_type": "text", "name": "max"}, {"chart_options": {"title": "Elevation Distribution", "x_label": "Elevation (m)", "y_label": "Area (ha)"}, "chart_type": "stacked_bar", "data_structure": {"x_field": "altitudes", "y_fields": [{"color": "#4BC0C0", "label": "For\u00eat", "name": "forest"}, {"color": "#FF6384", "label": "Hors-for\u00eat", "name": "non_forest"}]}, "name": "elevation_distribution"}]}, "forest": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "TEXT", "label": "Forest Area", "transformations": [{"chart_options": {"title": "Forest Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "forest_coordinates", "title": "Forest Location"}, "chart_type": "map", "name": "coordinates"}]}, "forest_cover": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "JSON", "label": "Forest Area", "transformations": [{"chart_options": {"categories": ["UM", "Non-UM", "Commune"], "title": "Forest Cover"}, "chart_type": "donut", "layer_params": {"forest_cover": [{"name": "area"}, {"attribute": "cover_type"}], "soil_types": [{"attribute": "soil_category"}]}, "name": "percentage"}]}, "forest_fragmentation": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Analysis of forest fragmentation", "field_type": "JSON", "label": "Forest Fragmentation", "transformations": [{"chart_options": {"bins": [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 7000, 12000, 17000, 27000, 500000], "title": "Forest Fragment Distribution", "x_label": "Area (ha)", "y_label": "Cumulative Area (%)"}, "chart_type": "line", "data_structure": {"color": "#4BC0C0", "x_field": "keys", "y_field": "values"}, "name": "fragment_size_distribution"}, {"chart_options": {"label": "Effective Mesh Size (km\u00b2)", "max": 1000, "min": 0, "title": "Fragmentation"}, "chart_type": "gauge", "name": "effective_mesh_size"}]}, "forest_humidity": {"data_source": [{"name": "forest_cover", "type": "layer"}, {"name": "holdridge", "type": "shape"}], "description": "Distribution of forests by humidity level", "field_type": "JSON", "label": "Forest and Living Environments", "transformations": [{"chart_options": {"categories": ["Dry", "Humid", "Very Humid"], "title": "Forest and Living Environments", "x_label": "Category", "y_label": "Frequency (%)"}, "chart_type": "stacked_bar", "layer_params": {"forest_cover": [{"name": "area"}], "humidity": [{"name": "value"}]}, "name": "category_distribution"}]}, "land_use": {"data_source": [{"name": "ultramafic", "type": "shape"}, {"name": "holdridge", "type": "shape"}, {"name": "forest_cover", "type": "layer"}], "description": "Land use distribution", "field_type": "JSON", "label": "Land Use", "transformations": [{"chart_options": {"title": "Land Use", "x_label": "Category", "y_label": "Area (ha)"}, "chart_type": "bar", "name": "category_distribution"}]}, "num_families": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of families in the zone", "field_type": "INTEGER", "label": "Number of Families", "transformations": [{"chart_options": {"title": "Number of Families"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["family"]}]}, "num_occurrences": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of occurrences in the zone", "field_type": "INTEGER", "label": "Number of Occurrences", "source_field": "id_occurrence", "transformations": [{"chart_options": {"title": "Number of Occurrences"}, "chart_type": "text", "name": "count"}]}, "num_species": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of species in the zone", "field_type": "INTEGER", "label": "Number of Species", "transformations": [{"chart_options": {"title": "Number of Species"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["species", "infra"]}]}, "rainfall": {"data_source": {"name": "rainfall", "type": "layer"}, "description": "Average annual rainfall within the shape", "field_type": "TEXT", "label": "Average Rainfall", "transformations": [{"chart_options": {"title": "Average Rainfall"}, "chart_type": "text", "name": "mean"}, {"chart_options": {"title": "Rainfall Range"}, "chart_type": "text", "name": "range"}]}, "shape": {"data_source": {"name": "self", "type": "shape"}, "description": "Total area of the reference zone", "field_type": "TEXT", "label": "Shape Area", "transformations": [{"chart_options": {"title": "Total Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "shape_coordinates", "title": "Location"}, "chart_type": "map", "name": "coordinates"}]}}, "group_by": "shape", "source_location_field": "geo_pt", "source_table_name": "occurrences"};
    var currentShapeType = "protected_areas";

    document.addEventListener('DOMContentLoaded', function () {
        loadShapeCharts(shape, mapping);
        loadShapeTypeList();
        initShapeMaps(mapping, shape);
        loadAllShapesMap(shape);
    });

    function loadShapeCharts(shape, mapping) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            if (field.field_type !== 'TEXT' && shape[field_key] !== null) {
                // Handle bins chart if present
                if (field.bins && field.bins.values && field.bins.values.length > 0) {
                    var binChartId = field_key + 'BinChart';
                    var binCtx = document.getElementById(binChartId);
                    if (binCtx) {
                        createBinChart(binCtx, field, shape);
                    }
                }

                // Handle transformations
                field.transformations.forEach(function(transformation) {
                    var transformationName = transformation.name ? transformation.name : '';
                    var valueKey = field_key + '_' + transformationName;

                    if (shape[valueKey] !== null) {
                        switch(transformation.chart_type) {
                            case 'pie':
                                var pieChartId = field_key + 'PieChart';
                                var pieCtx = document.getElementById(pieChartId);
                                if (pieCtx) {
                                    createPieChart(pieCtx, transformation, shape[valueKey]);
                                }
                                break;
                            case 'gauge':
                                var gaugeId = field_key + transformationName + 'Gauge';
                                var gaugeElement = document.getElementById(gaugeId);
                                if (gaugeElement) {
                                    createGauge({
                                        id: gaugeId,
                                        value: parseFloat(shape[valueKey]),
                                        min: 0,
                                        max: transformation.chart_options.max,
                                        title: transformation.chart_options.title,
                                        label: transformation.chart_options.label
                                    });
                                }
                                break;
                            case 'bar':
                                var barChartId = field_key + transformationName + 'BarChart';
                                var barCtx = document.getElementById(barChartId);
                                if (barCtx) {
                                    createBarChart(barCtx, field, transformation, shape[valueKey]);
                                }
                                break;
                            case 'stacked_bar':
                                if (field_key === 'elevation' && transformationName === 'elevation_distribution') {
                                    var stackedBarChartId = 'elevationDistributionChart';
                                    var stackedBarCtx = document.getElementById(stackedBarChartId);
                                    if (stackedBarCtx) {
                                        createElevationDistributionChart(stackedBarCtx, shape.elevation_elevation_distribution, transformation);
                                    }
                                }
                                break;
                            case 'line':
                                if (field_key === 'forest_fragmentation' && transformationName === 'fragment_size_distribution') {
                                    var lineChartId = 'forestFragmentationChart';
                                    var lineCtx = document.getElementById(lineChartId);
                                    if (lineCtx) {
                                        createForestFragmentationChart(lineCtx, shape.forest_fragmentation_fragment_size_distribution, transformation);
                                    }
                                }
                                break;
                        }
                    }
                });
            }
        });
    }

    function createBinChart(ctx, field, shape) {
        var binData = {
            labels: field.bins.values,
            datasets: [{
                label: field.label,
                data: field.bins.values.map(value => shape.frequencies[field.field_key][value] || 0),
                backgroundColor: field.bins.chart_options.color
            }]
        };

        new Chart(ctx, {
            type: field.bins.chart_type,
            data: binData,
            options: field.bins.chart_options
        });
    }

    function createPieChart(ctx, transformation, data) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['True', 'False'],
                datasets: [{
                    data: [data.true || 0, data.false || 0],
                    backgroundColor: ['#FF6384', '#36A2EB']
                }]
            },
            options: {
                title: {
                    display: true,
                    text: transformation.chart_options.title
                }
            }
        });
    }

    function createBarChart(ctx, field, transformation, data) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: field.label,
                    data: Object.values(data),
                    backgroundColor: getColor(0).background,
                    borderColor: getColor(0).border,
                    borderWidth: 1
                }]
            },
            options: transformation.chart_options
        });
    }

    function createElevationDistributionChart(ctx, elevationData, chartConfig) {
        const altitudes = elevationData.altitudes.reverse();
        const forestData = elevationData.forest.reverse();
        const nonForestData = elevationData.non_forest.reverse();

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: altitudes,
                datasets: [
                    {
                        label: 'Forest',
                        data: forestData,
                        backgroundColor: '#4CAF50',
                        stack: 'Stack 0',
                    },
                    {
                        label: 'Non-Forest',
                        data: nonForestData,
                        backgroundColor: '#FFF59D',
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Area (ha)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString(); // Format les grands nombres
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Elevation (m)'
                        },
                        reverse: false
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 0,
                        bottom: 10
                    }
                }
            }
        });
    }

    function createForestFragmentationChart(ctx, fragmentationData, chartConfig) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(fragmentationData),
                datasets: [{
                    label: 'Cumulative Area (%)',
                    data: Object.values(fragmentationData),
                    borderColor: '#4BC0C0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.x_label
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.y_label
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartConfig.chart_options.title
                    }
                }
            }
        });
    }

    function createGauge(options) {
        new JustGage({
            id: options.id,
            value: options.value || 0,
            min: options.min || 0,
            max: options.max,
            title: options.title,
            label: options.label,
            pointer: true,
            pointerOptions: {
                toplength: 10,
                bottomlength: 10,
                bottomwidth: 2,
                color: '#8e8e93',
                stroke: '#ffffff',
                stroke_width: 3,
                stroke_linecap: 'round'
            },
            gaugeWidthScale: 0.6,
            counter: true,
            donut: true,
            relativeGaugeSize: true,
            donutStartAngle: 270,
            hideInnerShadow: true,
            customSectors: [{
                color: "#ff0000",
                lo: 0,
                hi: options.max * 0.33
            }, {
                color: "#ffff00",
                lo: options.max * 0.33,
                hi: options.max * 0.66
            }, {
                color: "#00ff00",
                lo: options.max * 0.66,
                hi: options.max
            }],
            humanFriendly: true,
            formatNumber: true,
            textRenderer: function (val) {
                return parseFloat(val).toFixed(2);
            }
        });
    }

    // Function to get a color based on the index
    function getColor(index) {
        var colors = [
            {background: 'rgba(54, 162, 235, 0.6)', border: 'rgba(54, 162, 235, 1)'},
            {background: 'rgba(75, 192, 192, 0.6)', border: 'rgba(75, 192, 192, 1)'},
            {background: 'rgba(255, 99, 132, 0.6)', border: 'rgba(255, 99, 132, 1)'}
        ];
        return colors[index % colors.length];
    }

// Rest of the code (loadShapeTypeList, initShapeMaps, loadAllShapesMap) remains the same...

    let maps = {};  // Object to keep track of initialized maps

    function initMap(field_key, geometry) {
        const mapId = field_key + 'Map';
        const mapLoaderId = field_key + 'MapLoader';

        // Check if the map already exists
        if (maps[mapId]) {
            return; // Map is already initialized, so do nothing
        }

        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        map.on('load', function () {
            document.getElementById(mapLoaderId).style.display = 'none';
        });

        if (geometry) {
            const geoJsonLayer = L.geoJSON(geometry, {
                style: function() {
                    return {
                        color: '#228b22', // Border color
                        weight: 2,       // Border width
                        fillColor: '#228b22cc', // Fill color with opacity
                        fillOpacity: 0.8 // Fill opacity
                    };
                }
            }).addTo(map);
            map.fitBounds(geoJsonLayer.getBounds());
        } else {
            console.warn("No geographic coordinates found.");
            // Set default view if no geometry is found
            map.setView([-21.291237, 165.516418], 10);
        }

        // Store the map instance in the maps object
        maps[mapId] = map;
    }

    function initShapeMaps(mapping, shape) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            field.transformations.forEach(function(transformation) {
                if (transformation.chart_type === 'map') {
                    var coordinatesField = transformation.chart_options.coordinates_field;
                    var geometry = shape[coordinatesField];

                    // Check if geometry is a string, if so, parse it as JSON
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.error("Invalid JSON for field", coordinatesField, ":", geometry);
                            return; // Skip this field if JSON is invalid
                        }
                    }

                    // Initialize the map with the parsed geometry
                    initMap(field_key, geometry);
                }
            });
        });
    }

    function loadAllShapesMap(currentShape) {
        const mapId = 'allShapesMap';
        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        var group = L.featureGroup(); // Create a group to hold all the layers

        shapeTypes.forEach(function(shapeTypeItem) {
            if (shapeTypeItem.type === currentShape.type) {
                shapeTypeItem.shapes.forEach(function(shapeItem) {
                    var geometry = shapeItem.geometry;
                    // No need to parse geometry if it's already GeoJSON
                    var layer = L.geoJSON(geometry, {
                        style: function() {
                            return {
                                color: '#228b22', // Border color
                                weight: 2,       // Border width
                                fillColor: '#228b22cc', // Fill color with opacity
                                fillOpacity: 0.8 // Fill opacity
                            };
                        }
                    }).addTo(map);
                    group.addLayer(layer); // Add each layer to the group

                    // Highlight current shape
                    if (shapeItem.id === currentShape.id) {
                        layer.setStyle({color: 'red', weight: 3, fillOpacity: 0.4});
                        layer.bringToFront(); // Ensure the highlighted shape is on top
                    } else {
                        layer.setStyle({fillOpacity: 0.2}); // Reduce opacity for other shapes
                    }

                    // Show tooltip on hover with additional content
                    var tooltipContent = "<strong>" + shapeItem.name + "</strong><br>";

                    


                    layer.bindTooltip(tooltipContent, {
                        permanent: false,
                        direction: 'right',
                        offset: L.point(10, 0),
                        opacity: 0.9,
                        className: 'custom-tooltip'
                    });


                    layer.on('mousemove', function(e) {
                        var tooltip = e.target.getTooltip();
                        tooltip.setLatLng(e.latlng);
                    });

                    layer.on('click', function() {
                        window.location.href = '../shape/' + shapeItem.id + '.html';
                    });
                });
            }
        });

        map.fitBounds(group.getBounds()); // Adjust the view to fit the bounds of the group

        map.attributionControl.setPrefix(false);
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        maps['allShapesMap'] = map;
    }

    function loadShapeTypeList() {
            var shapeTypeListElement = document.getElementById("shape-type-list");
            shapeTypes.forEach(function (shapeTypeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "javascript:void(0)";
                a.textContent = shapeTypeItem.type;
                a.className = "shape-type-link";
                if (shapeTypeItem.type === currentShapeType) {
                    a.classList.add("active");
                }
                a.onclick = function () {
                    if (shapeTypeItem.shapes.length > 0) {
                        // Redirect to the first shape of the selected type
                        window.location.href = "../shape/" + shapeTypeItem.shapes[0].id + ".html";
                    }
                    loadShapeList(shapeTypeItem.shapes);
                };
                li.appendChild(a);
                shapeTypeListElement.appendChild(li);
            });
        }

        function loadShapeList(shapes) {
            var shapeListElement = document.getElementById("shape-list");
            shapeListElement.innerHTML = ''; // Clear the previous list
            shapes.forEach(function (shapeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "../shape/" + shapeItem.id + ".html";
                a.textContent = shapeItem.name;
                a.className = "shape-link";
                if (shapeItem.id === shape.id) {
                    a.classList.add("active");
                }
                li.appendChild(a);
                shapeListElement.appendChild(li);
            });
        }

</script>

</body>
</html>