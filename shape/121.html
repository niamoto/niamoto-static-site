<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Niamoto - Tiebaghi</title>
    <link rel="stylesheet" href="../js/vendor/tailwindcss/2.2.19_dist_tailwind.css">
    <link rel="stylesheet" href="../js/vendor/leaflet/1.9.4_leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
<script src="../js/shape_list.js"></script>

<style>
    #shape-type-list li, #shape-list li {
        list-style: none;
        text-transform: capitalize;
    }

    .shape-type-link, .shape-link {
        display: block;
        padding: 10px;
        border-radius: 5px;
        text-decoration: none;
    }

    .shape-type-link:hover, .shape-link:hover {
        background-color: #f0f0f0;
    }

    .shape-type-link.active, .shape-link.active {
        background-color: #3498db;
        color: #fff;
    }

    #shapeMap, #allShapesMap {
        position: relative;
        height: 300px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #allShapesMap {
        height: 400px;
    }

    .chart-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .chart-container > div {
        flex: 1 1 calc(33.333% - 10px);
        margin: 5px;
    }
    .custom-tooltip {
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    font-size: 12px;
    max-width: 300px;
    word-wrap: break-word;
}
</style>

    <style>
        .gauge {
            height: 349px;
        }

        ul {
            list-style-type: none;
        }

        .loader-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bg p-4 fixed w-full top-0 shadow-md z-50 custom-nav">
    <div class="container mx-auto flex flex-wrap items-center justify-between">
        <div class="flex items-center flex-shrink-0 text-white mr-6">
            <a id="home-link" class="inline-flex items-center py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                <span class="site-title">Niamoto</span>
            </a>
        </div>

        <div class="block lg:hidden">
            <button id="nav-toggle"
                class="flex items-center px-3 py-2 border rounded text-teal-200 border-teal-400 hover:text-white hover:border-white">
                <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <title>Menu</title>
                    <path d="M0 3h20v2H0zm0 6h20v2H0zm0 6h20v2H0z" />
                </svg>
            </button>
        </div>
        <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block pt-6 lg:pt-0" id="nav-content">
            <ul class="list-reset lg:flex justify-end flex-1 items-center">
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="index.html">
                        <i class="fas fa-home menu-icon"></i>Accueil
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#introduction">Introduction</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#project">Projet</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#objective">Objectifs</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#context">Contexte</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="index.html#flora">Flore</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="methodology.html">
                        <i class="fas fa-flask menu-icon"></i>Méthodologie
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#methodes">Nos méthodes</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="methodology.html#faq">FAQ</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="trees.html">
                        <i class="fas fa-leaf menu-icon"></i>Arbres
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#learnTaxon">Étudier les
                arbres</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="trees.html#taxon">Les arbres de
                Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="plots.html">
                        <i class="fas fa-map-marked-alt menu-icon"></i>Peuplements
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#learnPlot">Étudier les
                            peuplements forestiers</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="plots.html#plot">Les
                peuplements forestiers de Nouvelle-Calédonie</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="forests.html">
                        <i class="fas fa-tree menu-icon"></i>Forêt
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#preambule">Préambule</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#learnForest">Étudier les
                forêts</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPN">La forêt de la
                province Nord</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="forests.html#forestPS">La forêt de la
                province Sud</a></li>
                    </ul>
                </li>
                <li class="relative group mr-3">
                    <a class="nav-link inline-block py-2 px-4 text-white no-underline" href="#" data-link="resources.html">
                        <i class="fas fa-book menu-icon"></i>Ressources
                    </a>
                    <ul class="absolute hidden text-gray-700 pt-1 group-hover:block bg-white shadow-lg rounded-md z-50 w-48 custom-dropdown">
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#equipe">L'équipe</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#article">Articles</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#academic">Académique</a></li>
                        <li><a class="py-2 px-4 block whitespace-no-wrap hover:bg-gray-100" href="#" data-link="resources.html#media-production">Médias</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
  document.getElementById('nav-toggle').onclick = function () {
    document.getElementById('nav-content').classList.toggle('hidden');
  };

  // Function to adjust the navigation links based on page depth
  function adjustNavLinks(depth) {
    document.querySelectorAll('a[data-link]').forEach(link => {
      link.href = depth + link.getAttribute('data-link');
    });
  }

  // Adjust the navigation links based on the depth
  adjustNavLinks("../");
</script>

<style>
    .site-title {
        font-family: 'Arial Black', sans-serif; /* Custom font for a bold effect */
        font-size: 2rem; /* Increased font size */
        text-transform: uppercase; /* Uppercase letters for visibility */
        letter-spacing: 2px; /* Spacing between letters */
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7); /* Text shadow for better visibility */
        transition: color 0.3s; /* Smooth transition for hover effect */
    }

    .site-title:hover {
        color: #ffdd57; /* Change color on hover */
    }

    .text-contour {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .nav-bg {
        background-color: rgba(34, 139, 34, 0.8); /* Fond vert semi-transparent */
        transition: background-color 0.3s;
    }

    .nav-bg:hover {
        background-color: rgba(34, 139, 34, 1); /* Fond vert opaque au survol */
    }

    .group:hover .group-hover\:block {
        display: block;
    }

    .custom-nav {
        z-index: 500;
    }

    .custom-dropdown {
        z-index: 500;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2); /* Fond blanc transparent au survol */
        border-radius: 4px;
    }

    .menu-icon {
        margin-right: 8px;
    }
</style>
    <div class="flex">
        
<aside class="w-1/4 p-4 mt-28">
    <h2 class="font-semibold text-lg mb-4">Shape Types</h2>
    <ul id="shape-type-list" class="list-disc pl-5">
        <!-- The list of shape types will be generated by JavaScript -->
    </ul>
</aside>

        <div class="w-full">
            
<div id="allShapesMap" class="mt-28"></div>

<div class="rounded overflow-hidden shadow-lg mb-2 mt-8">
    <div class="px-6 py-4">
        <div class="font-bold text-4xl mb-2">Tiebaghi</div>
    </div>
</div>

<div class="chart-container">
    <!-- Section for general information -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">General Information</h2>
            
                
                    
                        
                        
                            <p>Shape Area (Total Area): 13266.233429351014</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Forest Area (Forest Area): 382.4115460377341</p>
                        
                    
                
                    
                
            
                
                    
                        
                        
                            <p>Number of Families (Number of Families): 72</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Species (Number of Species): 340</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Number of Occurrences (Number of Occurrences): 7675</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Average Rainfall (Average Rainfall): 1273.379638671875</p>
                        
                    
                
                    
                        
                        
                            <p>Average Rainfall (Rainfall Range): {"min": 930.0, "max": 1860.0}</p>
                        
                    
                
            
                
                    
                        
                        
                            <p>Altitude (Median Altitude): 84.0</p>
                        
                    
                
                    
                        
                        
                            <p>Altitude (Maximum Altitude): 597.0</p>
                        
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        </div>
    </div>

    <!-- Section for shape map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Shape Map</h2>
            <div id="shapeMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="shapeMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Section for forest map -->
    <div>
        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
            <h2 class="font-bold text-xl mb-2">Forest Map</h2>
            <div id="forestMap" style="height: 400px; position: relative;">
                <div class="loader-container" id="forestMapLoader">
                    <div class="loader"></div>
                </div>
                <!-- The Leaflet map will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div class="flex flex-wrap -mx-2">
    

    

    
    
        
    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
    
        
            
            

            
            
                
            
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Elevation Distribution</h2>
        
    
    
        <canvas id="elevationDistributionChart"></canvas>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Forest Fragment Distribution</h2>
        
    
    
        <canvas id="forestFragmentationChart"></canvas>
    
    
                        </div>
                    </div>
                
            
                
                    <div class="w-1/2 px-2 mb-4">
                        <div class="rounded overflow-hidden shadow-lg p-4 bg-white">
                            
    
        
            <h2 class="font-bold text-xl mb-2">Fragmentation</h2>
        
    
    
        <div class="gauge" id="forest_fragmentationeffective_mesh_sizeGauge"></div>
    
    
                        </div>
                    </div>
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
        
            
            

            
            
                
            

    
        
    
</div>

        </div>
    </div>
    <footer class="bg-green-700 text-white p-4 mt-8">
        <div class="container mx-auto">
            <div class="flex justify-center mb-4">
                <div class="bg-white p-2 rounded-lg shadow-md flex justify-center">
                    <figure class="mx-2"><img class="img-fluid" src="../files/ps_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/pn_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/amap_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/herbarium_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/iac_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/ird_100.png"></figure>
                    <figure class="mx-2"><img class="img-fluid" src="../files/cirad_100.png"></figure>
                </div>
            </div>
            <div class="text-center">
                <p>Niamoto - Portail de la forêt de Nouvelle-Calédonie</p>
                <a class="inline-block py-2 px-4 text-white no-underline" href="https://github.com/niamoto/niamoto" target="_blank">
                    <span class="fab fa-github fa-lg" aria-hidden="true"></span> Github
                </a>
            </div>
        </div>
    </footer>
    <script src="../js/vendor/chart/4.4.2_chart.js"></script>
    <script src="../js/vendor/d3/7.8.5_d3.js"></script>
    <script src="../js/vendor/jquery/3.6.0_jquery.js"></script>
    <script src="../js/vendor/raphael/2.3.0_raphael.js"></script>
    <script src="../js/vendor/justgage/1.6.1_justgage.js"></script>
    <script src="../js/vendor/leaflet/1.9.4_leaflet.js"></script>
    
<script>
    var shape = {"elevation_elevation_distribution": {"altitudes": [0.0, 100.0, 200.0, 300.0, 400.0, 500.0], "forest": [208.9208273317184, 51.118925836484294, 41.1173968684765, 54.45276882582023, 41.1173968684765, 4.445123985781243], "non_forest": [6318.743745788037, 1668.0327756644115, 1257.9700879760917, 913.4729790780455, 763.4500445579284, 684.5490938103114]}, "elevation_max": 597.0, "elevation_median": 84.0, "forest_area": "382.4115460377341", "forest_coordinates": "{\"type\": \"MultiPolygon\", \"coordinates\": [[[[164.19626363986825, -20.461459875104513], [164.19924961765147, -20.463018243095576], [164.19388004130533, -20.464858273502834], [164.1953675331574, -20.461750009344147], [164.19279107684474, -20.46265228815305], [164.1923137809503, -20.46134568389532], [164.19626363986825, -20.461459875104513]]], [[[164.19102943048446, -20.460363201823302], [164.18875879368056, -20.461762566763507], [164.18828629820285, -20.461813463081956], [164.18957454039534, -20.460024982708852], [164.19102943048446, -20.460363201823302]]], [[[164.18904919127814, -20.455977111801985], [164.19002998887575, -20.45703506093846], [164.19334217801585, -20.457086390860717], [164.19110876601545, -20.45807805627886], [164.18658544312908, -20.454862117745897], [164.18904919127814, -20.455977111801985]]], [[[164.19507440686962, -20.455013314052724], [164.19582075954403, -20.45624110185364], [164.19525181339785, -20.45670616118084], [164.19349567670398, -20.455181762732657], [164.19507440686962, -20.455013314052724]]], [[[164.18517636030217, -20.4548653040847], [164.18471770376513, -20.45442614563872], [164.18439807154036, -20.45368030363309], [164.18564885910288, -20.455408477571222], [164.18517636030217, -20.4548653040847]]], [[[164.196754238956, -20.452813770789646], [164.19700347060075, -20.453235095494147], [164.19641053917474, -20.453712261777135], [164.19618360345555, -20.452363970718896], [164.196754238956, -20.452813770789646]]], [[[164.19564555177203, -20.451158933758837], [164.1951730060551, -20.452080921437297], [164.19356515674718, -20.45152494180028], [164.19444088350673, -20.450195118886505], [164.19564555177203, -20.451158933758837]]], [[[164.1945767559311, -20.449053066778383], [164.19361129547445, -20.449490197488988], [164.1936392560144, -20.448341281915518], [164.19495955940468, -20.448586779962945], [164.1945767559311, -20.449053066778383]]], [[[164.18448238694614, -20.446546720998676], [164.1839159184639, -20.446941239053825], [164.18278060105038, -20.4460655637338], [164.1842493424957, -20.446024067571805], [164.18448238694614, -20.446546720998676]]], [[[164.18166714306835, -20.442825432598593], [164.18238180730668, -20.440740663713854], [164.18386456926973, -20.44150056980429], [164.1819771989627, -20.44332243287606], [164.18338262258723, -20.442798385657714], [164.1824303978906, -20.444160921050585], [164.1846291510057, -20.445240509246144], [164.18074590817727, -20.444739918317396], [164.18166714306835, -20.442825432598593]]], [[[164.1899084085557, -20.442671445264885], [164.18902310034684, -20.442561592387836], [164.18887965295926, -20.44236252735001], [164.19035285382895, -20.442246756439985], [164.1899084085557, -20.442671445264885]]], [[[164.18669038514474, -20.441558957310114], [164.18994528882948, -20.44065716774793], [164.19090905915292, -20.441305876510583], [164.1884068002619, -20.441218568404636], [164.18774827473783, -20.442005471985958], [164.18560305690454, -20.441885000251872], [164.18669038514474, -20.441558957310114]]], [[[164.19717495888156, -20.438117310440113], [164.1963085159966, -20.43895589160561], [164.1954513832874, -20.438696528532045], [164.19631087154195, -20.437806458188202], [164.19717495888156, -20.438117310440113]]], [[[164.19000538347365, -20.433733149186253], [164.19460289373404, -20.43513274810411], [164.19331192411275, -20.435754810217965], [164.19428770269784, -20.436847194082258], [164.1901038717298, -20.43603573600436], [164.19513590269264, -20.43835386278118], [164.19701498815834, -20.44082125545574], [164.18877297678165, -20.436068667055263], [164.1887287438717, -20.433626256597822], [164.19000538347365, -20.433733149186253]]], [[[164.1878502735781, -20.43316743499529], [164.18567705587725, -20.432893928338377], [164.1857134697388, -20.43244639268951], [164.1868756148825, -20.432348397896213], [164.1878502735781, -20.43316743499529]]], [[[164.18360370795912, -20.431079178775608], [164.18447162549694, -20.432069076707165], [164.1825765606931, -20.43343618938517], [164.18352985634021, -20.431762920363635], [164.18360370795912, -20.431079178775608]]], [[[164.17424328589402, -20.431114366928256], [164.17397962611292, -20.431704862353598], [164.17473006859728, -20.432527821475414], [164.17360865128492, -20.432013117351705], [164.17424328589402, -20.431114366928256]]], [[[164.18106980708458, -20.43072156769471], [164.18059262361416, -20.431401592799077], [164.17987934079892, -20.431295173651357], [164.181354549583, -20.429512588613076], [164.18106980708458, -20.43072156769471]]], [[[164.17775201370063, -20.429747277184273], [164.17864630340284, -20.428848649542672], [164.17759434903888, -20.432115306617078], [164.17801845557136, -20.43066848077944], [164.17775201370063, -20.429747277184273]]], [[[164.17654886523562, -20.430224969490958], [164.1756939132822, -20.43118378736833], [164.17544683663365, -20.43099568364505], [164.17597691302146, -20.429761411235177], [164.17654886523562, -20.430224969490958]]], [[[164.17352952598893, -20.429038055793754], [164.17283554115622, -20.429720449574756], [164.17221370482474, -20.43090109632082], [164.1721627314245, -20.430122777443817], [164.17352952598893, -20.429038055793754]]], [[[164.17101698198132, -20.428481172980387], [164.1712955851571, -20.42920942190525], [164.1698550338292, -20.429501372133025], [164.17087518373089, -20.42877321393428], [164.17101698198132, -20.428481172980387]]], [[[164.19923497414692, -20.425015193646242], [164.19975631516806, -20.42347210812625], [164.1999793011005, -20.426214541565376], [164.19839933922287, -20.42707887269039], [164.19923497414692, -20.425015193646242]]], [[[164.18792683912508, -20.415493899912008], [164.18832039342573, -20.417691362341923], [164.18805127495935, -20.418181147660942], [164.18779997917878, -20.41492787633635], [164.18792683912508, -20.415493899912008]]], [[[164.19506190522702, -20.411601314310396], [164.1913382989892, -20.419044763508797], [164.19049479471383, -20.41908168914882], [164.19217369879104, -20.414738595429856], [164.19506190522702, -20.411601314310396]]], [[[164.16034107128274, -20.40468583438337], [164.16097496642357, -20.402542614759625], [164.16138917257746, -20.402367410542734], [164.16243432529882, -20.404919957048893], [164.16110693071684, -20.404115120291603], [164.15946395404836, -20.40681057722917], [164.16034107128274, -20.40468583438337]]], [[[164.19957743219018, -20.401406656416132], [164.19973754734116, -20.40389892165981], [164.19830498065448, -20.405871507875847], [164.1972341646459, -20.40128172630743], [164.19957743219018, -20.401406656416132]]], [[[164.21907267112482, -20.504778450813976], [164.2200248219932, -20.50458200157696], [164.22110480873303, -20.503881337395093], [164.22008250968358, -20.504898909298138], [164.21770664487065, -20.5053729959803], [164.21907267112482, -20.504778450813976]]], [[[164.22494906966384, -20.50177407247718], [164.22450851480957, -20.503423879625263], [164.22263423651316, -20.500408284084354], [164.2247403890792, -20.500603242720775], [164.22494906966384, -20.50177407247718]]], [[[164.2202217702651, -20.493512937395103], [164.22093759956854, -20.494007044653895], [164.22333895577248, -20.49659387593479], [164.22097301448636, -20.49504413671446], [164.21989664047982, -20.493624348714217], [164.21995220032687, -20.49295671370869], [164.2202217702651, -20.493512937395103]]], [[[164.22675434775377, -20.49172268251882], [164.22649133222322, -20.491787032128308], [164.22566901571398, -20.49185172159421], [164.22756123266626, -20.49155507324633], [164.22675434775377, -20.49172268251882]]], [[[164.2198579201511, -20.489925682227415], [164.22049011309508, -20.489114766874213], [164.21901496824051, -20.49170331375862], [164.21902282281158, -20.491290814172864], [164.2198579201511, -20.489925682227415]]], [[[164.22353455287964, -20.489681014088866], [164.22299575925825, -20.490468783207596], [164.2218826152886, -20.48804731711657], [164.22387725376092, -20.48931861900402], [164.22353455287964, -20.489681014088866]]], [[[164.22683759345867, -20.4882515372516], [164.2259190800167, -20.48946675167372], [164.22527900989348, -20.48826998654146], [164.22574281562356, -20.488075275466198], [164.22683759345867, -20.4882515372516]]], [[[164.2107646362004, -20.489021421715762], [164.20960498306127, -20.489244193314477], [164.2094380052714, -20.48800086599928], [164.2107646934313, -20.48788962187319], [164.2107646362004, -20.489021421715762]]], [[[164.20945615952013, -20.48667367922235], [164.20862116057063, -20.48722098041148], [164.20768411866968, -20.48620055088728], [164.20837982714153, -20.48590368643587], [164.20945615952013, -20.48667367922235]]], [[[164.21995816760062, -20.48274652111525], [164.2194949314446, -20.483276034457283], [164.21891133973062, -20.48332236988209], [164.2191940431992, -20.481992661861177], [164.21995816760062, -20.48274652111525]]], [[[164.21547339788575, -20.480758337648297], [164.21556268554238, -20.479602546551313], [164.2184482035083, -20.479300615538556], [164.21755766838345, -20.482813069039103], [164.2152358521529, -20.483656656948035], [164.21547339788575, -20.480758337648297]]], [[[164.20558809841913, -20.481498234478778], [164.20534555811307, -20.48062334484359], [164.20608751356195, -20.480512059775815], [164.20604108653396, -20.481820176115257], [164.20558809841913, -20.481498234478778]]], [[[164.21967579517593, -20.480217697200622], [164.21975451352898, -20.480931068087763], [164.2186981263191, -20.481579784372144], [164.21860560129363, -20.481274213839754], [164.21967579517593, -20.480217697200622]]], [[[164.21441164374085, -20.481272752523925], [164.21393860036017, -20.482265053215045], [164.21338194032356, -20.479658202215123], [164.2143467713813, -20.479454097999575], [164.21441164374085, -20.481272752523925]]], [[[164.21080660889706, -20.47780655943965], [164.21378045482243, -20.47698721824413], [164.2114402326751, -20.481431447754197], [164.21100048876295, -20.480640943976294], [164.21050887197293, -20.476449944634414], [164.21080660889706, -20.47780655943965]]], [[[164.21550533652265, -20.475621102358293], [164.21524567697864, -20.473984146446412], [164.2166076438675, -20.47408618425813], [164.21668808284855, -20.474937036459306], [164.21438809286082, -20.476305869098123], [164.21550533652265, -20.475621102358293]]], [[[164.21328744263846, -20.473605897720024], [164.21423927753855, -20.474002719564282], [164.21386408639924, -20.474748512515337], [164.21224243000574, -20.473247299143537], [164.21328744263846, -20.473605897720024]]], [[[164.2026685759849, -20.471311215757478], [164.20790222550545, -20.468359815014956], [164.2124874882613, -20.472700178596646], [164.21044622622665, -20.473489242316152], [164.20857510498956, -20.470347921874637], [164.20549827920198, -20.471886660941323], [164.2015479158285, -20.471487339458957], [164.2026685759849, -20.471311215757478]]], [[[164.20768258566855, -20.4659100778074], [164.20784542239068, -20.46757153190308], [164.20635182969528, -20.467806066960808], [164.2075197070866, -20.466257617786813], [164.20609686515215, -20.466675200965266], [164.20625438258656, -20.465271258305], [164.20768258566855, -20.4659100778074]]], [[[164.20565173762532, -20.464394920697913], [164.20545726986995, -20.46434399639586], [164.2048548856684, -20.46337097901385], [164.20597705013455, -20.463566769312433], [164.20565173762532, -20.464394920697913]]], [[[164.2010447540861, -20.46211845372912], [164.20059920898328, -20.462803502315907], [164.2005585249801, -20.461438547516284], [164.20122552455632, -20.461818441590385], [164.2010447540861, -20.46211845372912]]], [[[164.21311284096475, -20.439451505843735], [164.21446473628527, -20.439426242567716], [164.21618447448103, -20.440067462773307], [164.2138024195687, -20.440969082824378], [164.21166654751124, -20.439565396769055], [164.21311284096475, -20.439451505843735]]], [[[164.2055389727668, -20.433533517021896], [164.20492593328447, -20.43410776793082], [164.2051210495949, -20.432564850686468], [164.20549265460684, -20.432685594739564], [164.2055389727668, -20.433533517021896]]], [[[164.22424296903515, -20.43588954196667], [164.22454325639376, -20.432507975065842], [164.22746543518323, -20.42882234316266], [164.22568839742615, -20.433245652558202], [164.22621652279227, -20.436575462463406], [164.22315788967154, -20.437501227647545], [164.22424296903515, -20.43588954196667]]], [[[164.20744516412515, -20.430351514060803], [164.20655258076985, -20.430844397156818], [164.20566972579093, -20.43057472482617], [164.2058741432089, -20.42955249381552], [164.20744516412515, -20.430351514060803]]], [[[164.20162485998694, -20.420598883932954], [164.20105788608348, -20.421584326476488], [164.2002959389757, -20.42205807238527], [164.2011140438833, -20.420710740318633], [164.20162485998694, -20.420598883932954]]], [[[164.2197010606059, -20.41847874763899], [164.2142888536066, -20.414577967848658], [164.21394879613425, -20.417210167929806], [164.21118703296244, -20.409631757687052], [164.2054435171395, -20.405479612071318], [164.2082858017231, -20.409880308234325], [164.20949547133023, -20.409255666872056], [164.20724359911154, -20.412873470487913], [164.20435670965946, -20.405572564134566], [164.19999812714548, -20.4047015714258], [164.20099682933736, -20.401416703274354], [164.20787350820652, -20.40085675650843], [164.2077732655692, -20.403001177992046], [164.21143118546124, -20.40732702113069], [164.21851464940616, -20.40780693459613], [164.21904238263113, -20.408741332919227], [164.21459206923464, -20.408973204129673], [164.2141844047503, -20.41103212738434], [164.21541837116766, -20.411362237533424], [164.21431629290507, -20.41240991372767], [164.2191377638513, -20.413634625598835], [164.21947550487928, -20.415980170244545], [164.22100289306164, -20.41523416186716], [164.22100838731438, -20.419809146340267], [164.2197010606059, -20.41847874763899]]], [[[164.23354452692587, -20.525666564288805], [164.23496567352746, -20.525164036293706], [164.23453555083222, -20.523801250916282], [164.23687759785213, -20.522522629325735], [164.23523498932036, -20.526648766563646], [164.233216872837, -20.52700021418267], [164.23354452692587, -20.525666564288805]]], [[[164.2485940538846, -20.50594102922114], [164.24830438663275, -20.50662534062507], [164.25072891774136, -20.504853497712006], [164.24933711055277, -20.507200902303314], [164.24745374539424, -20.507043286603572], [164.2485940538846, -20.50594102922114]]], [[[164.23522797991683, -20.504048717946056], [164.23604275874246, -20.50469678760195], [164.23589947407493, -20.505401185891625], [164.23522684020526, -20.504632844390578], [164.23522797991683, -20.504048717946056]]], [[[164.230514572652, -20.500201566533054], [164.2327118018626, -20.501413904284764], [164.23076351169624, -20.505020023758], [164.23022529833364, -20.50283944831041], [164.230514572652, -20.500201566533054]]], [[[164.2474905561548, -20.502672316174376], [164.24673903101672, -20.502106597436633], [164.24848322553282, -20.502848697997422], [164.24813084089698, -20.50283940824614], [164.2474905561548, -20.502672316174376]]], [[[164.24239111973077, -20.501538757367374], [164.2415929185928, -20.50267687882235], [164.2411616923516, -20.50230581327411], [164.24119414725612, -20.50170753539224], [164.24239111973077, -20.501538757367374]]], [[[164.25007941703208, -20.501957838014203], [164.24994033060875, -20.502124694784815], [164.24826094696982, -20.501410542251605], [164.24961336207303, -20.501048453091403], [164.25007941703208, -20.501957838014203]]], [[[164.2456143107875, -20.49904149136015], [164.24645111758414, -20.49722547057165], [164.2476294497812, -20.497735716878402], [164.24391786961766, -20.500760617763262], [164.2456143107875, -20.49904149136015]]], [[[164.23187685731648, -20.49839415339035], [164.23136664676085, -20.497874637529335], [164.23161706042328, -20.497225332973994], [164.23200654118816, -20.497327380460376], [164.23187685731648, -20.49839415339035]]], [[[164.23956595892773, -20.495315532855365], [164.23955200746786, -20.498574563479913], [164.23995512541813, -20.49643210279415], [164.2403261107034, -20.497614843478694], [164.23983908226595, -20.49921522778571], [164.2388749693171, -20.49747796729736], [164.23824323429503, -20.494812670666153], [164.23956595892773, -20.495315532855365]]], [[[164.22837389194905, -20.492678172082716], [164.23030837749718, -20.492520311665775], [164.23110172012565, -20.494261620571898], [164.22550182741773, -20.492399684012224], [164.22837389194905, -20.492678172082716]]], [[[164.229202895006, -20.483343418716803], [164.22918930775796, -20.482231903358397], [164.2303548708303, -20.484871967985512], [164.22765737048553, -20.482412843300633], [164.229202895006, -20.483343418716803]]], [[[164.23876908099513, -20.482935804974282], [164.23956722080342, -20.48252849869176], [164.23913954276142, -20.484341057487693], [164.2384801128856, -20.483167526929474], [164.2390373765458, -20.482240367913306], [164.23876908099513, -20.482935804974282]]], [[[164.2337261664222, -20.482982203511447], [164.2341127101213, -20.485021967037], [164.23200658053756, -20.48029789258597], [164.23291149085802, -20.480655370199113], [164.2337261664222, -20.482982203511447]]], [[[164.2522487815099, -20.480519967187128], [164.2537434453406, -20.48138003441277], [164.25332438614632, -20.48288685168417], [164.2527872356507, -20.482248191554543], [164.2522487815099, -20.480519967187128]]], [[[164.23937819844957, -20.478482910178197], [164.23911198468488, -20.47784272770931], [164.240135495688, -20.47821430624404], [164.2399949890504, -20.47841871045108], [164.23937819844957, -20.478482910178197]]], [[[164.24265744365832, -20.476634029879854], [164.2431560228649, -20.476940695315864], [164.24318407527198, -20.478809062152013], [164.24202373101352, -20.47686615660325], [164.24265744365832, -20.476634029879854]]], [[[164.2401158151461, -20.462008941364523], [164.2394096522613, -20.46183243305514], [164.23956760043248, -20.461525814236683], [164.2403668278427, -20.461358522479202], [164.2401158151461, -20.462008941364523]]], [[[164.23791230608893, -20.459182736232158], [164.2373080367396, -20.460493480685344], [164.23694577713331, -20.460577123470173], [164.23707485867138, -20.45916588608111], [164.23791230608893, -20.459182736232158]]], [[[164.22783513140288, -20.459360456480198], [164.22806665125006, -20.45846716465455], [164.22881954496748, -20.459824229996748], [164.2283457281943, -20.459972858796426], [164.22783513140288, -20.459360456480198]]], [[[164.2279642609142, -20.454310657192202], [164.2288381068119, -20.456319171735746], [164.22792732773053, -20.457090607454873], [164.22725813216647, -20.454664298441827], [164.22836388155585, -20.453558346713006], [164.2279642609142, -20.454310657192202]]], [[[164.23391169988963, -20.453408445528797], [164.23251093980517, -20.453659920815568], [164.23244597388023, -20.45257254977472], [164.2335054240547, -20.452767787941372], [164.23391169988963, -20.453408445528797]]], [[[164.23102962823796, -20.45222999030901], [164.2300100483149, -20.452590726782333], [164.22953586661913, -20.45140097875063], [164.23098583068108, -20.451800908810654], [164.23102962823796, -20.45222999030901]]], [[[164.2358662221745, -20.452266234901128], [164.23536527782932, -20.451493892994137], [164.23590425658048, -20.45099212223491], [164.23617361538751, -20.451847170291998], [164.2358662221745, -20.452266234901128]]], [[[164.2678579643299, -20.44468870364257], [164.26611065462524, -20.445283539759973], [164.26708082059244, -20.44894426833421], [164.26610928266444, -20.450092231728068], [164.26601288738297, -20.44883893182938], [164.26466809415302, -20.44918245275576], [164.26583462751444, -20.448291938262248], [164.26507435440578, -20.44548838772186], [164.2682792159746, -20.44336007825901], [164.2680408057829, -20.440631093352362], [164.2688461454626, -20.44262241683303], [164.2678579643299, -20.44468870364257]]], [[[164.26702075667828, -20.43943531592623], [164.26063182404516, -20.436263446510203], [164.25203655201068, -20.436494308826937], [164.26218153227458, -20.43603812726305], [164.26702075667828, -20.43943531592623]]]]}", "forest_cover_percentage": null, "forest_fragmentation_effective_mesh_size": 0.6071415078412655, "forest_fragmentation_fragment_size_distribution": {"10": 41.022851138086786, "100": 61.57881812504792, "1000": 100.0, "1100": 100.0, "1200": 100.0, "12000": 100.0, "125": 61.57881812504792, "1300": 100.0, "1400": 100.0, "150": 100.0, "1500": 100.0, "1600": 100.0, "1700": 100.0, "17000": 100.0, "175": 100.0, "1800": 100.0, "1900": 100.0, "20": 61.57881812504792, "200": 100.0, "2000": 100.0, "225": 100.0, "250": 100.0, "27000": 100.0, "275": 100.0, "30": 61.57881812504792, "300": 100.0, "325": 100.0, "350": 100.0, "375": 100.0, "40": 61.57881812504792, "400": 100.0, "425": 100.0, "450": 100.0, "475": 100.0, "50": 61.57881812504792, "500": 100.0, "500000": 100.0, "60": 61.57881812504792, "600": 100.0, "70": 61.57881812504792, "700": 100.0, "7000": 100.0, "80": 61.57881812504792, "800": 100.0, "90": 61.57881812504792, "900": 100.0}, "forest_humidity_category_distribution": null, "frequencies": {}, "id": 121, "land_use_category_distribution": null, "name": "Tiebaghi", "num_families_unique_taxonomic_count": 72, "num_occurrences_count": 7675, "num_species_unique_taxonomic_count": 340, "rainfall_mean": "1273.379638671875", "rainfall_range": "{\"min\": 930.0, \"max\": 1860.0}", "shape_area": "13266.233429351014", "shape_coordinates": "{\"type\": \"FeatureCollection\", \"features\": [{\"id\": \"0\", \"type\": \"Feature\", \"properties\": {}, \"geometry\": {\"type\": \"Polygon\", \"coordinates\": [[[164.2620111263737, -20.524044147070736], [164.26025212850868, -20.52886603635542], [164.25541835527426, -20.53214505306933], [164.21499400629642, -20.532873308640486], [164.20883222428904, -20.527077613447272], [164.20835266194663, -20.511834315647732], [164.19491988888106, -20.51167432599829], [164.18773641587893, -20.509173427114778], [164.17888675773295, -20.500919513723023], [164.16708652594897, -20.494666604360923], [164.1638920242057, -20.488796002251565], [164.16515209551164, -20.48303899698534], [164.16908792509412, -20.478806724667177], [164.1641945385505, -20.46720487225538], [164.16611063230565, -20.459732608543145], [164.16610430000196, -20.44865616293626], [164.16382894342837, -20.442932207750157], [164.16382313537292, -20.43394633874916], [164.15958549881066, -20.429813180746706], [164.1536915734872, -20.429411084626217], [164.14914136603667, -20.42726561918959], [164.14482892929325, -20.421902146637063], [164.14446118323383, -20.407215251466084], [164.14840652785577, -20.39991095624782], [164.1540331901404, -20.39818337295709], [164.16842736982207, -20.39817130761971], [164.17491087203845, -20.400692019323504], [164.21437186252345, -20.40129640169233], [164.22052464431863, -20.40708848727593], [164.22207193555678, -20.429010994184928], [164.23577419513782, -20.42910252537093], [164.24056726333282, -20.432376037010492], [164.2420650733223, -20.43567498777564], [164.25959989542397, -20.435655741066277], [164.26735725169496, -20.43937029242916], [164.26919410392765, -20.444677536382798], [164.2692232015677, -20.46825801927494], [164.2711378846856, -20.4736484136843], [164.27129515087788, -20.489084264403278], [164.26723914824612, -20.49644554705492], [164.26755448239575, -20.50746983082321], [164.26539439592085, -20.51961403281377], [164.2620111263737, -20.524044147070736]]]}, \"bbox\": [164.14446118323383, -20.532873308640486, 164.27129515087788, -20.39817130761971]}], \"bbox\": [164.14446118323383, -20.532873308640486, 164.27129515087788, -20.39817130761971]}", "shape_id": 121, "type": "mines"};
    var mapping = {"fields": {"elevation": {"data_source": {"name": "elevation", "type": "layer"}, "description": "Altitude metrics within the shape", "field_type": "JSON", "label": "Altitude", "transformations": [{"chart_options": {"title": "Median Altitude"}, "chart_type": "text", "name": "median"}, {"chart_options": {"title": "Maximum Altitude"}, "chart_type": "text", "name": "max"}, {"chart_options": {"title": "Elevation Distribution", "x_label": "Elevation (m)", "y_label": "Area (ha)"}, "chart_type": "stacked_bar", "data_structure": {"x_field": "altitudes", "y_fields": [{"color": "#4BC0C0", "label": "For\u00eat", "name": "forest"}, {"color": "#FF6384", "label": "Hors-for\u00eat", "name": "non_forest"}]}, "name": "elevation_distribution"}]}, "forest": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "TEXT", "label": "Forest Area", "transformations": [{"chart_options": {"title": "Forest Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "forest_coordinates", "title": "Forest Location"}, "chart_type": "map", "name": "coordinates"}]}, "forest_cover": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Area covered by forest within the shape", "field_type": "JSON", "label": "Forest Area", "transformations": [{"chart_options": {"categories": ["UM", "Non-UM", "Commune"], "title": "Forest Cover"}, "chart_type": "donut", "layer_params": {"forest_cover": [{"name": "area"}, {"attribute": "cover_type"}], "soil_types": [{"attribute": "soil_category"}]}, "name": "percentage"}]}, "forest_fragmentation": {"data_source": {"name": "forest_cover", "type": "layer"}, "description": "Analysis of forest fragmentation", "field_type": "JSON", "label": "Forest Fragmentation", "transformations": [{"chart_options": {"bins": [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350, 375, 400, 425, 450, 475, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 7000, 12000, 17000, 27000, 500000], "title": "Forest Fragment Distribution", "x_label": "Area (ha)", "y_label": "Cumulative Area (%)"}, "chart_type": "line", "data_structure": {"color": "#4BC0C0", "x_field": "keys", "y_field": "values"}, "name": "fragment_size_distribution"}, {"chart_options": {"label": "Effective Mesh Size (km\u00b2)", "max": 1000, "min": 0, "title": "Fragmentation"}, "chart_type": "gauge", "name": "effective_mesh_size"}]}, "forest_humidity": {"data_source": [{"name": "forest_cover", "type": "layer"}, {"name": "holdridge", "type": "shape"}], "description": "Distribution of forests by humidity level", "field_type": "JSON", "label": "Forest and Living Environments", "transformations": [{"chart_options": {"categories": ["Dry", "Humid", "Very Humid"], "title": "Forest and Living Environments", "x_label": "Category", "y_label": "Frequency (%)"}, "chart_type": "stacked_bar", "layer_params": {"forest_cover": [{"name": "area"}], "humidity": [{"name": "value"}]}, "name": "category_distribution"}]}, "land_use": {"data_source": [{"name": "ultramafic", "type": "shape"}, {"name": "holdridge", "type": "shape"}, {"name": "forest_cover", "type": "layer"}], "description": "Land use distribution", "field_type": "JSON", "label": "Land Use", "transformations": [{"chart_options": {"title": "Land Use", "x_label": "Category", "y_label": "Area (ha)"}, "chart_type": "bar", "name": "category_distribution"}]}, "num_families": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of families in the zone", "field_type": "INTEGER", "label": "Number of Families", "transformations": [{"chart_options": {"title": "Number of Families"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["family"]}]}, "num_occurrences": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of occurrences in the zone", "field_type": "INTEGER", "label": "Number of Occurrences", "source_field": "id_occurrence", "transformations": [{"chart_options": {"title": "Number of Occurrences"}, "chart_type": "text", "name": "count"}]}, "num_species": {"data_source": {"name": "occurrences", "type": "source"}, "description": "Total number of species in the zone", "field_type": "INTEGER", "label": "Number of Species", "transformations": [{"chart_options": {"title": "Number of Species"}, "chart_type": "text", "name": "unique_taxonomic_count", "target_ranks": ["species", "infra"]}]}, "rainfall": {"data_source": {"name": "rainfall", "type": "layer"}, "description": "Average annual rainfall within the shape", "field_type": "TEXT", "label": "Average Rainfall", "transformations": [{"chart_options": {"title": "Average Rainfall"}, "chart_type": "text", "name": "mean"}, {"chart_options": {"title": "Rainfall Range"}, "chart_type": "text", "name": "range"}]}, "shape": {"data_source": {"name": "self", "type": "shape"}, "description": "Total area of the reference zone", "field_type": "TEXT", "label": "Shape Area", "transformations": [{"chart_options": {"title": "Total Area"}, "chart_type": "text", "name": "area"}, {"chart_options": {"coordinates_field": "shape_coordinates", "title": "Location"}, "chart_type": "map", "name": "coordinates"}]}}, "group_by": "shape", "source_location_field": "geo_pt", "source_table_name": "occurrences"};
    var currentShapeType = "mines";

    document.addEventListener('DOMContentLoaded', function () {
        loadShapeCharts(shape, mapping);
        loadShapeTypeList();
        initShapeMaps(mapping, shape);
        loadAllShapesMap(shape);
    });

    function loadShapeCharts(shape, mapping) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            if (field.field_type !== 'TEXT' && shape[field_key] !== null) {
                // Handle bins chart if present
                if (field.bins && field.bins.values && field.bins.values.length > 0) {
                    var binChartId = field_key + 'BinChart';
                    var binCtx = document.getElementById(binChartId);
                    if (binCtx) {
                        createBinChart(binCtx, field, shape);
                    }
                }

                // Handle transformations
                field.transformations.forEach(function(transformation) {
                    var transformationName = transformation.name ? transformation.name : '';
                    var valueKey = field_key + '_' + transformationName;

                    if (shape[valueKey] !== null) {
                        switch(transformation.chart_type) {
                            case 'pie':
                                var pieChartId = field_key + 'PieChart';
                                var pieCtx = document.getElementById(pieChartId);
                                if (pieCtx) {
                                    createPieChart(pieCtx, transformation, shape[valueKey]);
                                }
                                break;
                            case 'gauge':
                                var gaugeId = field_key + transformationName + 'Gauge';
                                var gaugeElement = document.getElementById(gaugeId);
                                if (gaugeElement) {
                                    createGauge({
                                        id: gaugeId,
                                        value: parseFloat(shape[valueKey]),
                                        min: 0,
                                        max: transformation.chart_options.max,
                                        title: transformation.chart_options.title,
                                        label: transformation.chart_options.label
                                    });
                                }
                                break;
                            case 'bar':
                                var barChartId = field_key + transformationName + 'BarChart';
                                var barCtx = document.getElementById(barChartId);
                                if (barCtx) {
                                    createBarChart(barCtx, field, transformation, shape[valueKey]);
                                }
                                break;
                            case 'stacked_bar':
                                if (field_key === 'elevation' && transformationName === 'elevation_distribution') {
                                    var stackedBarChartId = 'elevationDistributionChart';
                                    var stackedBarCtx = document.getElementById(stackedBarChartId);
                                    if (stackedBarCtx) {
                                        createElevationDistributionChart(stackedBarCtx, shape.elevation_elevation_distribution, transformation);
                                    }
                                }
                                break;
                            case 'line':
                                if (field_key === 'forest_fragmentation' && transformationName === 'fragment_size_distribution') {
                                    var lineChartId = 'forestFragmentationChart';
                                    var lineCtx = document.getElementById(lineChartId);
                                    if (lineCtx) {
                                        createForestFragmentationChart(lineCtx, shape.forest_fragmentation_fragment_size_distribution, transformation);
                                    }
                                }
                                break;
                        }
                    }
                });
            }
        });
    }

    function createBinChart(ctx, field, shape) {
        var binData = {
            labels: field.bins.values,
            datasets: [{
                label: field.label,
                data: field.bins.values.map(value => shape.frequencies[field.field_key][value] || 0),
                backgroundColor: field.bins.chart_options.color
            }]
        };

        new Chart(ctx, {
            type: field.bins.chart_type,
            data: binData,
            options: field.bins.chart_options
        });
    }

    function createPieChart(ctx, transformation, data) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['True', 'False'],
                datasets: [{
                    data: [data.true || 0, data.false || 0],
                    backgroundColor: ['#FF6384', '#36A2EB']
                }]
            },
            options: {
                title: {
                    display: true,
                    text: transformation.chart_options.title
                }
            }
        });
    }

    function createBarChart(ctx, field, transformation, data) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: field.label,
                    data: Object.values(data),
                    backgroundColor: getColor(0).background,
                    borderColor: getColor(0).border,
                    borderWidth: 1
                }]
            },
            options: transformation.chart_options
        });
    }

    function createElevationDistributionChart(ctx, elevationData, chartConfig) {
        const altitudes = elevationData.altitudes.reverse();
        const forestData = elevationData.forest.reverse();
        const nonForestData = elevationData.non_forest.reverse();

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: altitudes,
                datasets: [
                    {
                        label: 'Forest',
                        data: forestData,
                        backgroundColor: '#4CAF50',
                        stack: 'Stack 0',
                    },
                    {
                        label: 'Non-Forest',
                        data: nonForestData,
                        backgroundColor: '#FFF59D',
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Area (ha)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString(); // Format les grands nombres
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Elevation (m)'
                        },
                        reverse: false
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 0,
                        bottom: 10
                    }
                }
            }
        });
    }

    function createForestFragmentationChart(ctx, fragmentationData, chartConfig) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(fragmentationData),
                datasets: [{
                    label: 'Cumulative Area (%)',
                    data: Object.values(fragmentationData),
                    borderColor: '#4BC0C0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.x_label
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: chartConfig.chart_options.y_label
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartConfig.chart_options.title
                    }
                }
            }
        });
    }

    function createGauge(options) {
        new JustGage({
            id: options.id,
            value: options.value || 0,
            min: options.min || 0,
            max: options.max,
            title: options.title,
            label: options.label,
            pointer: true,
            pointerOptions: {
                toplength: 10,
                bottomlength: 10,
                bottomwidth: 2,
                color: '#8e8e93',
                stroke: '#ffffff',
                stroke_width: 3,
                stroke_linecap: 'round'
            },
            gaugeWidthScale: 0.6,
            counter: true,
            donut: true,
            relativeGaugeSize: true,
            donutStartAngle: 270,
            hideInnerShadow: true,
            customSectors: [{
                color: "#ff0000",
                lo: 0,
                hi: options.max * 0.33
            }, {
                color: "#ffff00",
                lo: options.max * 0.33,
                hi: options.max * 0.66
            }, {
                color: "#00ff00",
                lo: options.max * 0.66,
                hi: options.max
            }],
            humanFriendly: true,
            formatNumber: true,
            textRenderer: function (val) {
                return parseFloat(val).toFixed(2);
            }
        });
    }

    // Function to get a color based on the index
    function getColor(index) {
        var colors = [
            {background: 'rgba(54, 162, 235, 0.6)', border: 'rgba(54, 162, 235, 1)'},
            {background: 'rgba(75, 192, 192, 0.6)', border: 'rgba(75, 192, 192, 1)'},
            {background: 'rgba(255, 99, 132, 0.6)', border: 'rgba(255, 99, 132, 1)'}
        ];
        return colors[index % colors.length];
    }

// Rest of the code (loadShapeTypeList, initShapeMaps, loadAllShapesMap) remains the same...

    let maps = {};  // Object to keep track of initialized maps

    function initMap(field_key, geometry) {
        const mapId = field_key + 'Map';
        const mapLoaderId = field_key + 'MapLoader';

        // Check if the map already exists
        if (maps[mapId]) {
            return; // Map is already initialized, so do nothing
        }

        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        map.on('load', function () {
            document.getElementById(mapLoaderId).style.display = 'none';
        });

        if (geometry) {
            const geoJsonLayer = L.geoJSON(geometry, {
                style: function() {
                    return {
                        color: '#228b22', // Border color
                        weight: 2,       // Border width
                        fillColor: '#228b22cc', // Fill color with opacity
                        fillOpacity: 0.8 // Fill opacity
                    };
                }
            }).addTo(map);
            map.fitBounds(geoJsonLayer.getBounds());
        } else {
            console.warn("No geographic coordinates found.");
            // Set default view if no geometry is found
            map.setView([-21.291237, 165.516418], 10);
        }

        // Store the map instance in the maps object
        maps[mapId] = map;
    }

    function initShapeMaps(mapping, shape) {
        Object.entries(mapping.fields).forEach(function([field_key, field]) {
            field.transformations.forEach(function(transformation) {
                if (transformation.chart_type === 'map') {
                    var coordinatesField = transformation.chart_options.coordinates_field;
                    var geometry = shape[coordinatesField];

                    // Check if geometry is a string, if so, parse it as JSON
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.error("Invalid JSON for field", coordinatesField, ":", geometry);
                            return; // Skip this field if JSON is invalid
                        }
                    }

                    // Initialize the map with the parsed geometry
                    initMap(field_key, geometry);
                }
            });
        });
    }

    function loadAllShapesMap(currentShape) {
        const mapId = 'allShapesMap';
        const satellite = L.tileLayer.wms("https://carto10.gouv.nc/arcgis/services/fond_imagerie/MapServer/WMSServer", {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const carte = L.tileLayer.wms('https://carto.gouv.nc/arcgis/services/fond_cartographie/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: "<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>"
        });
        const map = L.map(mapId, {
            layers: [carte, satellite],
            scrollWheelZoom: false
        });
        map.attributionControl.setPrefix(false); // Remove the "Powered by Leaflet" prefix
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        const baseMaps = {
            "Carte": carte,
            "Satellite": satellite,
        };

        L.control.layers(baseMaps).addTo(map);

        var group = L.featureGroup(); // Create a group to hold all the layers

        shapeTypes.forEach(function(shapeTypeItem) {
            if (shapeTypeItem.type === currentShape.type) {
                shapeTypeItem.shapes.forEach(function(shapeItem) {
                    var geometry = shapeItem.geometry;
                    // No need to parse geometry if it's already GeoJSON
                    var layer = L.geoJSON(geometry, {
                        style: function() {
                            return {
                                color: '#228b22', // Border color
                                weight: 2,       // Border width
                                fillColor: '#228b22cc', // Fill color with opacity
                                fillOpacity: 0.8 // Fill opacity
                            };
                        }
                    }).addTo(map);
                    group.addLayer(layer); // Add each layer to the group

                    // Highlight current shape
                    if (shapeItem.id === currentShape.id) {
                        layer.setStyle({color: 'red', weight: 3, fillOpacity: 0.4});
                        layer.bringToFront(); // Ensure the highlighted shape is on top
                    } else {
                        layer.setStyle({fillOpacity: 0.2}); // Reduce opacity for other shapes
                    }

                    // Show tooltip on hover with additional content
                    var tooltipContent = "<strong>" + shapeItem.name + "</strong><br>";

                    


                    layer.bindTooltip(tooltipContent, {
                        permanent: false,
                        direction: 'right',
                        offset: L.point(10, 0),
                        opacity: 0.9,
                        className: 'custom-tooltip'
                    });


                    layer.on('mousemove', function(e) {
                        var tooltip = e.target.getTooltip();
                        tooltip.setLatLng(e.latlng);
                    });

                    layer.on('click', function() {
                        window.location.href = '../shape/' + shapeItem.id + '.html';
                    });
                });
            }
        });

        map.fitBounds(group.getBounds()); // Adjust the view to fit the bounds of the group

        map.attributionControl.setPrefix(false);
        map.attributionControl.addAttribution("<a href='http://www.geoportal.gouv.nc/'>Géorep</a> <i> - Gouvernement de la Nouvelle-Calédonie</i>");

        maps['allShapesMap'] = map;
    }

    function loadShapeTypeList() {
            var shapeTypeListElement = document.getElementById("shape-type-list");
            shapeTypes.forEach(function (shapeTypeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "javascript:void(0)";
                a.textContent = shapeTypeItem.type;
                a.className = "shape-type-link";
                if (shapeTypeItem.type === currentShapeType) {
                    a.classList.add("active");
                }
                a.onclick = function () {
                    if (shapeTypeItem.shapes.length > 0) {
                        // Redirect to the first shape of the selected type
                        window.location.href = "../shape/" + shapeTypeItem.shapes[0].id + ".html";
                    }
                    loadShapeList(shapeTypeItem.shapes);
                };
                li.appendChild(a);
                shapeTypeListElement.appendChild(li);
            });
        }

        function loadShapeList(shapes) {
            var shapeListElement = document.getElementById("shape-list");
            shapeListElement.innerHTML = ''; // Clear the previous list
            shapes.forEach(function (shapeItem) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.href = "../shape/" + shapeItem.id + ".html";
                a.textContent = shapeItem.name;
                a.className = "shape-link";
                if (shapeItem.id === shape.id) {
                    a.classList.add("active");
                }
                li.appendChild(a);
                shapeListElement.appendChild(li);
            });
        }

</script>

</body>
</html>